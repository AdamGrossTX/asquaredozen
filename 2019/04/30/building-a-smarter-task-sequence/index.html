<!DOCTYPE html>
<html lang="en-us">
	    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="keyword"  content="ConfigMgr Microsoft MVP Gross Intune Windows">
        <link rel="shortcut icon" href="/img/favicon.ico">
        <title>Building a Smarter Task Sequence-A Square Dozen | A. Gross Blog</title>

        <meta name="description" content="A.Gross Blog | Adam Gross Enterprise Mobility MVP">
        

        
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DYVXTRTXN4"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-DYVXTRTXN4', { 'anonymize_ip': false });
}
</script>

        <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.asquaredozen.com/105"/>

<meta name="twitter:title" content="Building a Smarter Task Sequence"/>
<meta name="twitter:description" content="I&rsquo;m procrastinating prepping my sessions for MMS 2019 and decided I should write a blog post instead to help get me motivated. A few weeks ago I tweeted that my task sequence is built to be re-run if it fails and it will &lsquo;pick up where it left off&rsquo;. Several folks expressed interest in the idea so I wanted to share the general framework for having a task sequence that can be re-run after failure to complete the job."/>


        <link rel="canonical" href="/2019/04/30/building-a-smarter-task-sequence/">
        <link rel="stylesheet" href="/css/style.css">
        <link rel="stylesheet" href="/css/code.css">

        
        <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" type="text/css">

        
        

        
    </head>
		<body class="home blog">
			<div id="asd-container">
				
				
<div id="top-bar">
    <div class="container">
        <div id="nav-wrapper">
                <ul class="menu" id="menu-top-menu">
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                        <a href="/">Home</a>
                    </li>
                    
                    
                        
                            <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                <a href="#">
                                    
                                    <span>Feature Updates</span>
                                </a>
                                <ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2019/08/22/windows-10-feature-updates-leveraging-setupdiag-for-better-reporting/">Windows 10 Feature Updates – Leveraging SetupDiag for Better Reporting</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2019/10/05/windows-10-feature-updates-the-challenge-of-servicing-in-the-enterprise/">Windows 10 Feature Updates – The Challenge of Servicing in the Enterprise</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2019/08/25/windows-10-feature-updates-using-custom-action-scripts/">Windows 10 Feature Updates – Using Custom Action Scripts</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2019/08/25/windows-10-feature-updates-using-setupconfig-ini-to-manage-feature-updates-in-the-enterprise/">Windows 10 Feature Updates – Using Setupconfig.ini to Manage Feature Updates in the Enterprise</a>
                                        </li>
                                    
                                </ul>
                            </li>
                        
                    
                        
                            <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                <a href="/2019/02/12/the-system-center-configuration-manager-adminservice-guide/">
                                    
                                    <span>ConfigMgr AdminService</span>
                                </a>
                            </li>
                        
                    
                        
                            <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                <a href="#">
                                    
                                    <span>802.1x for OSD</span>
                                </a>
                                <ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-1-building-an-802-1x-computer-authentication-script/">Part 1 – Building an 802.1x Computer Authentication Script</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-2-building-an-802-1x-enabled-winpe-boot-image/">Part 2 – Building an 802.1x Enabled WinPE Boot Image</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-3-integrating-802-1x-authentication-into-a-bare-metal-task-sequence/">Part 3 – Integrating 802.1x Authentication into a Bare Metal Task Sequence</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-4-integrating-802-1x-authentication-into-an-in-place-upgrade-task-sequence/">Part 4 – Integrating 802.1x Authentication into an In-Place Upgrade Task Sequence</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2018/09/29/configuring-802-1x-authentication-for-windows-deployment-part-5-dynamic-whitelisting-using-the-cisco-ise-external-restful-service/">Part 5 – Dynamic Whitelisting using the Cisco ISE External RESTful Service</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-tips-and-tricks/">Tips and Tricks</a>
                                        </li>
                                    
                                </ul>
                            </li>
                        
                    
                        
                            <li class="active menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                <a href="#">
                                    
                                    <span>Task Sequence Hacks</span>
                                </a>
                                <ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2018/11/29/building-a-better-task-sequence/">Building a Better Task Sequence</a>
                                        </li>
                                    
                                        <li class="active menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2019/04/30/building-a-smarter-task-sequence/">Building a Smarter Task Sequence</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2018/12/14/building-an-even-better-task-sequence/">Building An Even Better Task Sequence</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2018/07/16/clearing-local-group-policies-during-an-windows-7-to-10-in-place-upgrade-task-sequence/">Clearing Local Group Policies during an Windows 7 to 10 In-Place Upgrade Task Sequence</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2018/10/03/debugging-sccm-configmgr-task-sequences-on-the-fly/">Debugging SCCM/ConfigMgr Task Sequences on the Fly</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2018/07/11/dynamically-updating-unattend-xml-during-an-osd-task-sequence-using-mdt-variables-and-zti-scripts/">Dynamically Updating Unattend.XML during an OSD Task Sequence using MDT Variables and ZTI Scripts.</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2018/06/14/triggering-configmgr-client-actions-from-a-task-sequence/">Triggering ConfigMgr Client Actions from a Task Sequence</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/2018/08/27/using-sccm-task-sequence-variables-as-scripts/">Using SCCM Task Sequence Variables as Scripts</a>
                                        </li>
                                    
                                </ul>
                            </li>
                        
                    
                        
                            <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                <a href="https://github.com/AdamGrossTX">
                                    
                                    <span>GitHub</span>
                                </a>
                            </li>
                        
                    
                        
                            <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                <a href="#">
                                    
                                    <span>MORE&gt;</span>
                                </a>
                                <ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/about/">About</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/consulting/">Consulting</a>
                                        </li>
                                    
                                        <li class=" menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
                                            <a href="/contact/">Contact</a>
                                        </li>
                                    
                                </ul>
                            </li>
                        
                    
                
                </ul>
        </div>
    </div>
</div>
				<header id="header" class="noslider">
	<div class="container">
		<div id="logo">
			<h1><a href="https://blog.asquaredozen.com"><img src="/img/A-Square-Dozen-Logo-BlogHeader-1.png" alt="A Square Dozen" /></a></h1>
		</div>
	</div>
</header>
				<div class="container">
					<div id="content">
						<div id="main">
							
		<article class="post type-post status-publish format-standard has-post-thumbnail hentry">
			<div class="post-header">
				<h1>Building a Smarter Task Sequence</h1>
				<span class="post-date">April 30, 2019</span>
			</div>
			<div class="post-entry">
				<p>I&rsquo;m procrastinating prepping my sessions for <a href="https://mms2019.sched.com/speaker/grossac">MMS 2019</a> and decided I should write a blog post instead to help get me motivated. A few weeks ago <a href="https://twitter.com/AdamGrossTX/status/1102259922048294914">I tweeted</a> that my task sequence is built to be re-run if it fails and it will &lsquo;pick up where it left off&rsquo;. Several folks expressed interest in the idea so I wanted to share the general framework for having a task sequence that can be re-run after failure to complete the job. If you haven&rsquo;t already done so, check out my <a href="/2018/11/29/building-a-better-task-sequence/">other posts</a> on <a href="/2018/12/14/building-an-even-better-task-sequence/">adding error handling</a> in your task sequence. I believe that <a href="https://twitter.com/gwblok/">Gary Blok</a> is going to have some improvements on that process to showcase at <a href="https://mmsmoa.com/">MMS</a> as well, so keep an eye out for that. (I think I need a few more hyperlinks&hellip;)</p>
<hr>
<p><strong>Disclaimer:</strong>
These steps depend on the updated Run PowerShell Script Step in ConfigMgr 1902 CB.</p>
<hr>
<h2 id="background-and-concept">Background and Concept</h2>
<p>I have a single (~700 step) task sequence that handles Bare Metal/Replace, InPlace Upgrades and InPlace Refresh (a Bare Metal launched from the OS instead of from WinPE). It installs a few core applications and site-specific apps, plus it supports about 30 hardware models. Several sections including USMT and Dynamic Apps are broken out into child task sequences that can be run within the main task sequence or standalone.
We use a small wizard to gather info about the build type and primary user, then we use a REST API and database backend to handle the rest - no need to ask questions that we can just look up in a database. From there, we use task sequence variables to determine which steps of the task Sequence to run. I have plans to break things into more child task sequences, but we had to go with what we had for now and just plan on changes for the next iteration.</p>
<p>As I was building, I was inspired by the AutoPilot idea of just using the existing OS and building from there. I realized that any failure AFTER the OS gets installed is really an incomplete success (what??). I should just be able to pick up there instead of formatting and starting all over; why throw out a perfectly good OS? This model is also why I don&rsquo;t like to customize my base WIM other than <a href="/2018/08/20/adding-dynamic-updates-to-windows-10-in-place-upgrade-media-during-offline-servicing/">offline servicing</a>. We want to be able to seamlessly transition to AutoPilot whenever the time comes to jump into it.</p>
<p>During testing, we were able to take a device sitting at OOBE, manually join the domain, install the ConfigMgr client and have the TS launch and pick up just after the OS install steps and build just as if we had done a full wipe &amp; load. This approach didn&rsquo;t save any time and was all manual, but conceptually, it proved that we just need a good OS installed and we can do anything from there, as long as we aren&rsquo;t relying on customizations baked into the image.</p>
<h2 id="planning-for-failure">Planning for Failure</h2>
<p>If you&rsquo;ve read my <a href="/task-sequence-hacks/">error handling posts</a>, you know that I recommend not using Continue on error for any steps that are critical to you build. If your final build MUST require a specific application, then don&rsquo;t allow that step to continue if a failure occurs (and if you are OK with letting it fail, you should really consider why it needs to be in the task sequence to begin with). You can capture data about these failures and leave some bread crumbs that the task sequence can use to determine where to pick up.</p>
<h4 id="build-versioning">Build Versioning</h4>
<p>The last steps in my task sequence write build and task sequence version numbers. I set these values as variables at the beginning of the task sequence and I update them any time I update anything in the task sequence. You can (should) <a href="https://www.systemcenterdudes.com/sccm-windows-10-inventory-upgrade-fresh/">extend your hardware inventory</a> to pick up the registry keys for tracking your builds as well. It is a very quick indicator of a failed machine if I see workstation without these registry keys in inventory.</p>
<h4 id="milestone-logging">Milestone Logging</h4>
<p>One concept that I haven&rsquo;t implemented into production yet is milestone logging. The idea is that at the end of each main section of the task sequence, we set a variable or write a registry entry or local file that you can query to determine where to jump to in the task sequence. I haven&rsquo;t found a way to tell the task sequence go to a specific step when it starts, so you have to add criteria onto your groups to check for the name of the last run group. Here&rsquo;s an example of what I mean:</p>
<p>A Smarter Task Sequence
<img src="/img/2019/04/image-7.png" alt="A Square Dozen Image"></p>
<p>We have a variable called <code>CustOSLastStepNum</code> that only gets set if a group succeeded. At the end of each group, add a <strong>Set Task Sequence Variable</strong> step to set <code>CustOSLastStepNum</code> to a number assigned to a variable with the same name as the group. If the task sequence fails, write the<br>
<code>CustOSLastStepNum</code> variable to the registry or a file. Then add criteria to each main group to check if <code>CustOSLastStepNum</code> is less than the number and if so, skip the step.</p>
<p>Variables for each main group
<img src="/img/2019/04/image-6.png" alt="A Square Dozen Image"></p>
<h2 id="putting-it-together">Putting it Together</h2>
<p>Adding this logic will take some careful planning to ensure you aren&rsquo;t skipping over key parts of your task sequence when you restart. The sample task sequence includes a <code>CustDeploymentType</code> that gets set to <code>AlreadyInstalled</code> if the <code>CustBuildVersion</code> registry key exists or it gets set to Recovery if the <code>CustLastStepNum</code> registry key has a number greater than 0. Essentially, you can add a check to each group to skip if the <code>CustDeploymentType</code> is set to <code>Recovery</code> or <code>AlreadyInstalled</code> to have more global control over which steps run.</p>
<p>Custom registry keys
<img src="/img/2019/04/image-8.png" alt="A Square Dozen Image"></p>
<p>When the task sequence runs any Install Application steps, the application detection method logic will run and automatically skip anything that has already been installed. In production, we have logic on any place that can&rsquo;t be re-run as well so we don&rsquo;t cause an error by re-running the step.</p>
<h2 id="sample-task-sequence">Sample Task Sequence</h2>
<p>Since the task sequence is self documenting, you should just download it and walk through the steps - be sure to check each step and group Options tab to follow the criteria - but I&rsquo;d like to highlight a few bits.</p>
<p>Each RunPowerShell script has a simple registry read or write in it. If you import the sample task sequence below, the script content will import.</p>
<p>1902 Run PowerShell Script Step
<img src="/img/2019/04/image-9.png" alt="1902 Run PowerShell Script Step"></p>
<p>Get Registry Value Script
<img src="/img/2019/04/image-10.png" alt="Get Registry Value Script"></p>
<p>For the sake of clarity and centralized management, I&rsquo;m using variables for each group number, but you could just as easily use numbers for comparisons on the groups.</p>
<p>Centralize variables for use in each group
<img src="/img/2019/04/image-13.png" alt="Centralize variables for use in each group"></p>
<p>Using Variables for comparison
<img src="/img/2019/04/image-11.png" alt="Using Variables for comparison"></p>
<p>Alternative approach - Numbers for comparison - No variables needed.
<img src="/img/2019/04/image-12.png" alt="Alternative approach - Numbers for comparison - No variables needed."></p>
<h2 id="summary">Summary</h2>
<p>If you are managing complex task sequences or in place upgrades, adding some simple steps to your task sequence can allow you to save time and troubleshooting effort and greatly improve your user experience. Import the sample <a href="https://github.com/AdamGrossTX/BlogFiles/raw/master/Building%20A%20Smarter%20Task%20Sequence.zip">Task Sequence from GitHub</a> and get started testing. I hope this methodology improves the success of your deployments as well as it has for my site.</p>

			</div>
			
			<script src="https://utteranc.es/client.js"
				repo="AdamGrossTX/asquaredozen"
				issue-term="title"
				label="blog comment"
				theme="github-light"
				crossorigin="anonymous"
				async>
			</script>
		</article>

						</div>
						<aside id="sidebar">
	<div class="widget widget_search">
		<form role="search" method="get" action="https://www.google.com/search" id="searchform">
			<input type="search" placeholder="Search and hit enter..." value="" name="q" id="q" title="Search and hit enter...">
			<input type="hidden" name="sitesearch" value="asquaredozen.com">
			<button type="submit" value="Search"/>
		</form>
		</div>
	<div>
	<div class="widget widget_MVP">
		<a href="https://mvp.microsoft.com/en-us/PublicProfile/5003519?fullName=Adam%20Gross" target="_blank">
		<img src="/img/MVP_Logo_Horizontal_Secondary_Black_RGB_300ppi.png">
		</a>
	</div>	
	<div class="widget widget_recent_entries">
		<h4 class="widget-title">Recent Posts</h4>
		<ul>
			
			<li><a href="/2021/02/04/using-configmgr-run-scripts-and-microsoft-quick-assist-to-repair-a-broken-domain-trust-relationship/" target="_blank">Using ConfigMgr Run Scripts and Microsoft Quick Assist to Repair a Broken Domain Trust Relationship</a></li>
			
			<li><a href="/2021/01/12/how-to-find-settings-preventing-application-deletion-in-configmgr/" target="_blank">How to find Settings Preventing Application Deletion in ConfigMgr</a></li>
			
			<li><a href="/2020/12/02/autopilot-profile-causes-device-rename-after-configmgr-osd-task-sequence-and-breaks-ad-domain-trust/" target="_blank">Autopilot Profile causes Device Rename after ConfigMgr OSD Task Sequence and Breaks AD Domain Trust</a></li>
			
			<li><a href="/2020/09/30/new-post-on-sysmansquad-com-configmgr-and-the-case-of-the-mysterious-3da228be-34da-49f4-a081-66465b077429-folder/" target="_blank">New Post on SysManSquad.com – ConfigMgr and The Case of the Mysterious {3DA228BE-34DA-49f4-A081-66465B077429} Folder</a></li>
			
			<li><a href="/2020/09/13/windows-10-feature-updates-testing-the-migneo-disable-parameter/" target="_blank">Windows 10 Feature Updates – Testing the /MigNEO Disable Parameter</a></li>
			
		</ul>
	</div>
	<div class="widget widget_SCD">
		<h4 class="widget-title">Consulting</h4>
		<a href="https://systemcenterdudes.com/sccm-consulting-services/?ref=5&campaign=Consulting" target="_blank">
		<img src="/img/SCDLogo.png">
		</a>
	</div>
	<div class="widget widget_SCD">
		<h4 class="widget-title">Intune.Training</h4>
		<a href="http://intune.training" target="_blank">
		<img src="/img/ITLogo.png">
		</a>
	</div>	
</aside>

					</div>
				</div>
				<footer id="footer">
	<div class="container">
		<div id="footer-copyright">
			<p class="copyright">&copy; 2021 Adam Gross - https://blog.asquaredozen.com - A Square Dozen</a></p>
		</div>
	</div>
</footer>

			</div>
		</body>
</html>
