<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=keyword content="ConfigMgr Microsoft MVP Gross Intune Windows">
<meta name=viewport content="width=device-width">
<meta name=description content="A.Gross Blog | Adam Gross Enterprise Mobility MVP">
<link rel="shortcut icon" href=/img/favicon.ico>
<title>When VDI and ConfigMgr Co-Management Collide-A Square Dozen | A. Gross Blog</title>
<link rel=canonical href=/2021/11/13/when-vdi-and-configmgr-co-management-collide/>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=https://www.asquaredozen.com/css/custom.css>
<script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://www.asquaredozen.com/js/jquery.slicknav.js></script>
<script src=https://www.asquaredozen.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://www.asquaredozen.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DYVXTRTXN4"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-DYVXTRTXN4',{anonymize_ip:!1})}</script>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://www.asquaredozen.com/105">
<meta name=twitter:title content="When VDI and ConfigMgr Co-Management Collide">
<meta name=twitter:description content="Before we begin, here are some notes about persistent and non-persistent VDI that will likely give you nightmares:
 Intune doesn&rsquo;t support non-persistent VDI Azure Active Directory only supports Hybrid Azure AD Join for non-persistent VDI ConfigMgr recommends limiting client functionality on non-persistent VDI but there is no mention about the impact of Co-Management on these devices. Whatever you do, don&rsquo;t Hybrid Join then Co-Manage your VDI Master Image or you&rsquo;re in for a bad time!">
</head>
<body class="home blog">
<div id=asd-container>
<div id=top-bar>
<div class=container>
<div id=nav-wrapper>
<ul class=menu id=menu-top-menu>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/>Home</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>Feature Updates</span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/08/22/windows-10-feature-updates-leveraging-setupdiag-for-better-reporting/>Windows 10 Feature Updates – Leveraging SetupDiag for Better Reporting</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/10/05/windows-10-feature-updates-the-challenge-of-servicing-in-the-enterprise/>Windows 10 Feature Updates – The Challenge of Servicing in the Enterprise</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/08/25/windows-10-feature-updates-using-custom-action-scripts/>Windows 10 Feature Updates – Using Custom Action Scripts</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/08/25/windows-10-feature-updates-using-setupconfig-ini-to-manage-feature-updates-in-the-enterprise/>Windows 10 Feature Updates – Using Setupconfig.ini to Manage Feature Updates in the Enterprise</a>
</li>
</ul>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/02/12/the-system-center-configuration-manager-adminservice-guide/>
<span>ConfigMgr AdminService</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>802.1x for OSD</span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-1-building-an-802-1x-computer-authentication-script/>Part 1 – Building an 802.1x Computer Authentication Script</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-2-building-an-802-1x-enabled-winpe-boot-image/>Part 2 – Building an 802.1x Enabled WinPE Boot Image</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-3-integrating-802-1x-authentication-into-a-bare-metal-task-sequence/>Part 3 – Integrating 802.1x Authentication into a Bare Metal Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-4-integrating-802-1x-authentication-into-an-in-place-upgrade-task-sequence/>Part 4 – Integrating 802.1x Authentication into an In-Place Upgrade Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/09/29/configuring-802-1x-authentication-for-windows-deployment-part-5-dynamic-whitelisting-using-the-cisco-ise-external-restful-service/>Part 5 – Dynamic Whitelisting using the Cisco ISE External RESTful Service</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-tips-and-tricks/>Tips and Tricks</a>
</li>
</ul>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>Task Sequence Hacks</span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/11/29/building-a-better-task-sequence/>Building a Better Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/04/30/building-a-smarter-task-sequence/>Building a Smarter Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/12/14/building-an-even-better-task-sequence/>Building An Even Better Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/16/clearing-local-group-policies-during-an-windows-7-to-10-in-place-upgrade-task-sequence/>Clearing Local Group Policies during an Windows 7 to 10 In-Place Upgrade Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/10/03/debugging-sccm-configmgr-task-sequences-on-the-fly/>Debugging SCCM/ConfigMgr Task Sequences on the Fly</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/11/dynamically-updating-unattend-xml-during-an-osd-task-sequence-using-mdt-variables-and-zti-scripts/>Dynamically Updating Unattend.XML during an OSD Task Sequence using MDT Variables and ZTI Scripts.</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/06/14/triggering-configmgr-client-actions-from-a-task-sequence/>Triggering ConfigMgr Client Actions from a Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/08/27/using-sccm-task-sequence-variables-as-scripts/>Using SCCM Task Sequence Variables as Scripts</a>
</li>
</ul>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=https://github.com/AdamGrossTX>
<span>GitHub</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>MORE></span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/about/>About</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/consulting/>Consulting</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/contact/>Contact</a>
</li>
</ul>
</li>
</ul>
</div>
<div id=top-search>
<a href=# class=search><i class="fa fa-search"></i></a>
<div class=show-search>
<form role=search method=get action=https://www.google.com/search id=searchform>
<input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://www.asquaredozen.com>
<button type=submit value=Search>
</form>
</div>
</div>
<div class=menu id=menu-mobile></div>
</div>
</div>
<header id=header class=noslider>
<div class=container>
<div id=logo>
<h1><a href=https://www.asquaredozen.com><img src=/img/A-Square-Dozen-Logo-BlogHeader-1.png alt="A Square Dozen"></a></h1>
</div>
</div>
</header>
<div class=container>
<div id=content>
<div id=main class=fullwidth>
<article class="post type-post status-publish format-standard has-post-thumbnail hentry">
<div class=post-header>
<h1>When VDI and ConfigMgr Co-Management Collide</h1>
<span class=post-date>November 13, 2021</span>
</div>
<div class=post-entry>
<p>Before we begin, here are some notes about persistent and non-persistent VDI that will likely give you nightmares:</p>
<ul>
<li><a href=https://docs.microsoft.com/en-us/mem/intune/fundamentals/windows-10-virtual-machines><strong>Intune</strong> doesn&rsquo;t support non-persistent VDI</a></li>
<li><a href=https://docs.microsoft.com/en-us/azure/active-directory/devices/howto-device-identity-virtual-desktop-infrastructure><strong>Azure Active Directory</strong> only supports Hybrid Azure AD Join for non-persistent VDI</a></li>
<li><a href=https://docs.microsoft.com/en-us/mem/configmgr/core/clients/deploy/plan/considerations-for-managing-clients-in-a-vdi><strong>ConfigMgr</strong> recommends limiting client functionality on non-persistent VDI</a> but there is no mention about the impact of Co-Management on these devices.</li>
<li>Whatever you do, don&rsquo;t Hybrid Join then Co-Manage your VDI Master Image or you&rsquo;re in for a bad time!!</li>
</ul>
<p><div class=image>
<figure>
<a href=2021-11-13_3-02-21.jpg target=_blank>
<img src=2021-11-13_3-02-21.jpg alt="Failed Azure AD Join">
</a>
<figcaption>Failed Azure AD Join</figcaption>
</figure>
</div></p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=21><a style=outline:none;text-decoration:none;color:inherit href=#21>21</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=22><a style=outline:none;text-decoration:none;color:inherit href=#22>22</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=23><a style=outline:none;text-decoration:none;color:inherit href=#23>23</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=24><a style=outline:none;text-decoration:none;color:inherit href=#24>24</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=25><a style=outline:none;text-decoration:none;color:inherit href=#25>25</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=26><a style=outline:none;text-decoration:none;color:inherit href=#26>26</a>
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext>+----------------------------------------------------------------------+
| Diagnostic Data                                                      |
+----------------------------------------------------------------------+

     Diagnostics Reference : www.microsoft.com/aadjerrors
              User Context : UN-ELEVATED User
               Client Time : 2021-11-13 07:34:49.000 UTC
      AD Connectivity Test : PASS
     AD Configuration Test : PASS
        DRS Discovery Test : PASS
     DRS Connectivity Test : PASS
    Token acquisition Test : SKIPPED
     Fallback to Sync-Join : ENABLED

     Previous Registration : 2021-11-13 07:14:20.000 UTC
         Registration Type : sync
               Error Phase : join
          Client ErrorCode : 0x801c03f3
          Server ErrorCode : invalid_request
       Server ErrorSubCode : error_missing_device
          Server Operation : DeviceRenew
            Server Message : The device object by the given id (f3751f0c-ed18-4205-8079-645ae0c9efaf) is not found.
              Https Status : 400
                Request Id : 82955534-26d6-4c06-8929-1c62096d7a36
    Executing Account Name : ASD\Adam

</code></pre></td></tr></table>
</div>
</div><h2 id=what-have-we-done>What have we done??</h2>
<p>Today&rsquo;s problem was discovered when our VDI master images were built and updated using ConfigMgr in an environment where Hybrid Azure AD Join and Co-Management is enabled for all devices (which automatically Intune Enrolls devices). When the master image is cloned to create new worker VMs (persistent or non-persistent), the new VMs all share the same Azure AD and Intune device IDs. Within Azure and Intune, if you search for a specific Device by ID a single device record is returned which changes randomly depending on which device checked in last.</p>
<p>We now run the script linked below along with BISF scripts and many other custom steps to clean up the master image and we disable the ConfigMgr client so that it doesn&rsquo;t launch on the <strong>non-persistent</strong> devices, which prevents Co-Management from kicking in and re-enrolling into Intune. For <strong>persistent</strong> VDI cloned from master images, we re-enable ConfigMgr and manage the devices as regular worksations.</p>
<h2 id=take-the-good-with-the-bad>Take the Good with the Bad</h2>
<p>If you have ever used a device which has not been Hybrid Azure AD joined to access any Microsoft cloud resources, you&rsquo;ve likely been prompted numerous times to enter your Azure AD credentials. This can be overcome by hybrid joining your device to Azure AD. This has a huge user experience benefit but when used on cloned devices can really cause some issues. If you want the device to be Hybrid Azure AD Joined, then you will need to prepare your master image properly before cloning.</p>
<h2 id=take-your-pick>Take your Pick</h2>
<p>The best part about this issue when using ConfigMgr is that it&rsquo;s super easy to find devices with duplicate Azure AD Device IDs. The quickest way is to add the <strong>Azure Active Directory Device ID</strong> column to the ConfigMgr console. You can even group by the column to make is easier to find devices sharing the same ID.</p>
<p><div class=image>
<figure>
<a href=2021-11-13_20-17-31.jpg target=_blank>
<img src=2021-11-13_20-17-31.jpg alt="Right Click and Select Azure Active Directory Device ID">
</a>
<figcaption>Right Click and Select Azure Active Directory Device ID</figcaption>
</figure>
</div></p>
<p><div class=image>
<figure>
<a href=2021-11-13_20-17-56.jpg target=_blank>
<img src=2021-11-13_20-17-56.jpg alt="Sort to find the same ID">
</a>
<figcaption>Sort to find the same ID</figcaption>
</figure>
</div></p>
<p><div class=image>
<figure>
<a href=2021-11-13_20-19-30.jpg target=_blank>
<img src=2021-11-13_20-19-30.jpg alt="Scroll to the bottom of the list to select Group By">
</a>
<figcaption>Scroll to the bottom of the list to select Group By</figcaption>
</figure>
</div></p>
<p><div class=image>
<figure>
<a href=2021-11-13_20-18-28.jpg target=_blank>
<img src=2021-11-13_20-18-28.jpg alt="Grouped by Azure Active Directory Device ID">
</a>
<figcaption>Grouped by Azure Active Directory Device ID</figcaption>
</figure>
</div></p>
<p>Another alternative is to create a collection to help quickly determine how many devices are using duplicate IDs. I&rsquo;ve uploaded a MOF file to my repo that you can import to create a new collection. <a href=https://github.com/AdamGrossTX/Toolbox/blob/a2dc2aac1efcb9908f5deaede4c8fc5244b92ac0/ConfigMgr/Collections/Collection%20-%20Duplicate%20Azure%20AD%20Device%20ID.MOF>Duplicate Azure AD Device ID.MOF</a></p>
<p><div class=image>
<figure>
<a href=2021-11-13_20-32-30.png target=_blank>
<img src=2021-11-13_20-32-30.png alt="Duplicate Azure AD Device ID Collection">
</a>
<figcaption>Duplicate Azure AD Device ID Collection</figcaption>
</figure>
</div></p>
<p><div class=image>
<figure>
<a href=2021-11-13_20-33-28.png target=_blank>
<img src=2021-11-13_20-33-28.png alt="Grouped by Azure Active Directory Device ID">
</a>
<figcaption>Grouped by Azure Active Directory Device ID</figcaption>
</figure>
</div></p>
<h2 id=too-much-of-a-good-thing>Too Much of a Good Thing</h2>
<p>While searching for a solution to this problem, I frequently ran across solutions for handling Azure AD and ConfigMgr but nothing much related to Intune and <a href=https://docs.microsoft.com/en-us/mem/configmgr/comanage/overview>Co-Management</a>. When <a href=https://docs.microsoft.com/en-us/mem/configmgr/comanage/tutorial-co-manage-clients>Co-Management is enabled</a>, the Enablement tab has an option for <strong>Automatic enrollment in Intune</strong> which can target a pilot collection or all devices.</p>
<p><div class=image>
<figure>
<a href=2021-11-13_0-26-22.jpg target=_blank>
<img src=2021-11-13_0-26-22.jpg alt="Co-Management Options">
</a>
<figcaption>Co-Management Options</figcaption>
</figure>
</div></p>
<p>Unfortunately, <strong>All</strong> means just that. The moment a device is (Hybrid) Azure AD Joined it will trigger the Co-Management handler service which immediately triggers the Intune enrollment process for the device. You can watch CoManagementHandler.log on a client to see this in action.</p>
<p>Co-Management isn&rsquo;t great on a master image.</p>
<h2 id=if-we-could-turn-back-time>If We Could Turn Back Time</h2>
<p>Once a master image has been enrolled in Intune, you can&rsquo;t just use <code>DSREGCMD /LEAVE</code> in the cleanup script before re-sealing it - each clone will still think that it is Intune enrolled and it will continue to re-register in Azure AD with the same device ID as the master.</p>
<p><div class=image>
<figure>
<a href=2021-11-13_0-38-46.jpg target=_blank>
<img src=2021-11-13_0-38-46.jpg alt="Hybrid Azure AD Joined and Intune Enrolled">
</a>
<figcaption>Hybrid Azure AD Joined and Intune Enrolled</figcaption>
</figure>
</div></p>
<p>The first step here is going to be un-enrolling the device from Intune. Unfortunately, that&rsquo;s not really a feature that exists natively so we have to cleanup the client so that it no longer thinks that it&rsquo;s enrolled in Intune so that we can disjoin and rejoin Azure AD.</p>
<h2 id=un-enrolling---just-like-enrolling-only-backwards>Un-Enrolling - Just like Enrolling, only Backwards</h2>
<p>To reverse the process, we need to delete everything listed below.</p>
<h3 id=scheduled-tasks>Scheduled Tasks</h3>
<ul>
<li><strong>Task Scheduler Library</strong> > <strong>Microsoft</strong> > <strong>Windows</strong> > <strong>EnterpriseMgmt</strong></li>
<li>New GUID folder created. This is the key to the rest of the puzzle.</li>
</ul>
<p><div class=image>
<figure>
<a href=2021-11-13_1-35-27.jpg target=_blank>
<img src=2021-11-13_1-35-27.jpg alt="Scheduled Task GUID is Key">
</a>
<figcaption>Scheduled Task GUID is Key</figcaption>
</figure>
</div></p>
<h4 id=registry-keys>Registry Keys</h4>
<ul>
<li>Several keys get created, but only these need to be deleted</li>
<li>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Enrollments&lt;ScheduledTaskGUID></li>
<li>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Enrollments\Status&lt;ScheduledTaskGUID></li>
<li>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\EnterpriseResourceManager\Tracked&lt;ScheduledTaskGUID></li>
<li>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PolicyManager\AdmxInstalled&lt;ScheduledTaskGUID></li>
<li>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\PolicyManager\Providers&lt;ScheduledTaskGUID></li>
<li>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Provisioning\OMADM\Accounts&lt;ScheduledTaskGUID></li>
<li>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Provisioning\OMADM\Logger&lt;ScheduledTaskGUID></li>
<li>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Provisioning\OMADM\Sessions&lt;ScheduledTaskGUID></li>
</ul>
<p><div class=image>
<figure>
<a href=2021-11-13_1-36-52.jpg target=_blank>
<img src=2021-11-13_1-36-52.jpg alt="Enrollment Registry Entries">
</a>
<figcaption>Enrollment Registry Entries</figcaption>
</figure>
</div></p>
<p><div class=image>
<figure>
<a href=2021-11-13_1-37-34.jpg target=_blank>
<img src=2021-11-13_1-37-34.jpg alt="Intune Device ID">
</a>
<figcaption>Intune Device ID</figcaption>
</figure>
</div></p>
<h4 id=certificates>Certificates</h4>
<ul>
<li>2 certificates will be created. One for Azure and one for MDM. Delete both.</li>
<li>Note that the GUID in Issued To for the certs will match the Intune and Azure AD Device IDs</li>
<li>Issued By <strong>Microsoft Intune MDM Device CA</strong></li>
<li>Issued By <strong>MS-Organization-Access</strong></li>
<li>Issued By <strong>MS-Organization-P2P-Access</strong></li>
</ul>
<p><div class=image>
<figure>
<a href=2021-11-13_1-25-57.jpg target=_blank>
<img src=2021-11-13_1-25-57.jpg alt="They are Connected!">
</a>
<figcaption>They are Connected!</figcaption>
</figure>
</div></p>
<p>Once you delete all of the items listed above, you can safely disjoin from Azure AD using <code>DSREGCMD /LEAVE</code>. But wait, there&rsquo;s an easier way!</p>
<h2 id=one-script-to-unenroll-them-all>One Script to UnEnroll them All</h2>
<p>Ok so I took you through all of the manual goodness because, just like GI JOE always says &ldquo;Knowing is half the battle!&rdquo;. The other half is hoping you don&rsquo;t run out of broken VMs to test the script on before you get it working!</p>
<p><div class=image>
<figure>
<a href=200.gif target=_blank>
<img src=200.gif alt="Knowing Is Half the Battle">
</a>
</figure>
</div></p>
<p>The script is written to be run in ConfigMgr. Instead of posting the script content here, I&rsquo;m just going to link my repo so that any changes are updated there. Check out the comments in the code for more details and for updates.</p>
<p><em>Note - This has only been tested for Hybrid Azure AD Joined Devices.</em>
<a href=https://github.com/AdamGrossTX/Toolbox/blob/master/Intune/Intune-UnHybridJoin.ps1>https://github.com/AdamGrossTX/Toolbox/blob/master/Intune/Intune-UnHybridJoin.ps1</a></p>
<h2 id=parting-thoughts>Parting Thoughts</h2>
<p>One question comment I&rsquo;m sure I&rsquo;ll get is around Co-Management and using pilot collections instead of deploying to all devices. One major reason not to leave Co-Management in pilot mode is because it targets a collection. That collection will need to be populated and updated when a new device is built and that takes time. Targeting all devices allows a device to immediately become Co-Managed as soon as the client pulls down policies. That seems like a better experience than using pilot to work around this.</p>
</div>
<comments id=comments>
<script src=https://utteranc.es/client.js repo=AdamGrossTX/asquaredozen issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script>
</comments>
</article>
</div>
</div>
</div>
<footer id=footer>
<div class=container>
<div id=footer-copyright>
<p class=copyright>&copy; 2021 Adam Gross - https://www.asquaredozen.com - A Square Dozen</a></p>
</div>
</div>
</footer>
</div>
</body>
</html>