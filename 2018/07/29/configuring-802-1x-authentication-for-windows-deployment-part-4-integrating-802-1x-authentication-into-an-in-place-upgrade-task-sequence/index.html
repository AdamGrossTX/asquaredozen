<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=keyword content="ConfigMgr Microsoft MVP Gross Intune Windows"><meta name=viewport content="width=device-width"><meta name=description content="A.Gross Blog | Adam Gross Enterprise Mobility MVP"><link rel="shortcut icon" href=/img/favicon.ico><title>Configuring 802.1x Authentication for Windows Deployment – Part 4 – Integrating 802.1x Authentication into an In-Place Upgrade Task Sequence-A Square Dozen | A. Gross Blog</title><link rel=canonical href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-4-integrating-802-1x-authentication-into-an-in-place-upgrade-task-sequence/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://www.asquaredozen.com/css/custom.css><script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://www.asquaredozen.com/js/jquery.slicknav.js></script>
<script src=https://www.asquaredozen.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://www.asquaredozen.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DYVXTRTXN4"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-DYVXTRTXN4",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.asquaredozen.com/img/ASquareDozen-Logo_Horiz_Twitter.png"><meta name=twitter:title content="Configuring 802.1x Authentication for Windows Deployment – Part 4 – Integrating 802.1x Authentication into an In-Place Upgrade Task Sequence"><meta name=twitter:description content="This is Part 4 in my Configuring 802.1x Authentication for Windows Deployment series. Be sure to check out all of the other parts here.
Quick Note About Cisco Switch Firmware If you&rsquo;ve made it this far, a word of caution. Make sure that your switch firmware is matched to the version required by ISE. I spent several weeks working with our Security and Networking guys to troubleshoot and discovered that our switches weren&rsquo;t at the required version for ISE 2."><meta property="og:title" content="Configuring 802.1x Authentication for Windows Deployment – Part 4 – Integrating 802.1x Authentication into an In-Place Upgrade Task Sequence"><meta property="og:description" content="This is Part 4 in my Configuring 802.1x Authentication for Windows Deployment series. Be sure to check out all of the other parts here.
Quick Note About Cisco Switch Firmware If you&rsquo;ve made it this far, a word of caution. Make sure that your switch firmware is matched to the version required by ISE. I spent several weeks working with our Security and Networking guys to troubleshoot and discovered that our switches weren&rsquo;t at the required version for ISE 2."><meta property="og:type" content="article"><meta property="og:url" content="https://www.asquaredozen.com/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-4-integrating-802-1x-authentication-into-an-in-place-upgrade-task-sequence/"><meta property="og:image" content="https://www.asquaredozen.com/img/ASquareDozen-Logo_Horiz_Twitter.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-07-30T04:10:44+00:00"><meta property="article:modified_time" content="2018-07-30T04:10:44+00:00"><meta property="og:site_name" content="A Square Dozen | A. Gross Blog"></head><body class="home blog"><div id=asd-container><div id=top-bar><div class=container><div id=nav-wrapper><ul class=menu id=menu-top-menu><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>Feature Updates</span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/08/22/windows-10-feature-updates-leveraging-setupdiag-for-better-reporting/>Windows 10 Feature Updates – Leveraging SetupDiag for Better Reporting</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/10/05/windows-10-feature-updates-the-challenge-of-servicing-in-the-enterprise/>Windows 10 Feature Updates – The Challenge of Servicing in the Enterprise</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/08/25/windows-10-feature-updates-using-custom-action-scripts/>Windows 10 Feature Updates – Using Custom Action Scripts</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/08/25/windows-10-feature-updates-using-setupconfig-ini-to-manage-feature-updates-in-the-enterprise/>Windows 10 Feature Updates – Using Setupconfig.ini to Manage Feature Updates in the Enterprise</a></li></ul></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/02/12/the-system-center-configuration-manager-adminservice-guide/><span>ConfigMgr AdminService</span></a></li><li class="active menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>802.1x for OSD</span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-1-building-an-802-1x-computer-authentication-script/>Part 1 – Building an 802.1x Computer Authentication Script</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-2-building-an-802-1x-enabled-winpe-boot-image/>Part 2 – Building an 802.1x Enabled WinPE Boot Image</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-3-integrating-802-1x-authentication-into-a-bare-metal-task-sequence/>Part 3 – Integrating 802.1x Authentication into a Bare Metal Task Sequence</a></li><li class="active menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-4-integrating-802-1x-authentication-into-an-in-place-upgrade-task-sequence/>Part 4 – Integrating 802.1x Authentication into an In-Place Upgrade Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/09/29/configuring-802-1x-authentication-for-windows-deployment-part-5-dynamic-whitelisting-using-the-cisco-ise-external-restful-service/>Part 5 – Dynamic Whitelisting using the Cisco ISE External RESTful Service</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-tips-and-tricks/>Tips and Tricks</a></li></ul></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>Task Sequence Hacks</span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/11/29/building-a-better-task-sequence/>Building a Better Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/04/30/building-a-smarter-task-sequence/>Building a Smarter Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/12/14/building-an-even-better-task-sequence/>Building An Even Better Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/16/clearing-local-group-policies-during-an-windows-7-to-10-in-place-upgrade-task-sequence/>Clearing Local Group Policies during an Windows 7 to 10 In-Place Upgrade Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/10/03/debugging-sccm-configmgr-task-sequences-on-the-fly/>Debugging SCCM/ConfigMgr Task Sequences on the Fly</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/11/dynamically-updating-unattend-xml-during-an-osd-task-sequence-using-mdt-variables-and-zti-scripts/>Dynamically Updating Unattend.XML during an OSD Task Sequence using MDT Variables and ZTI Scripts.</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/06/14/triggering-configmgr-client-actions-from-a-task-sequence/>Triggering ConfigMgr Client Actions from a Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/08/27/using-sccm-task-sequence-variables-as-scripts/>Using SCCM Task Sequence Variables as Scripts</a></li></ul></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=https://github.com/AdamGrossTX><span>GitHub</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>MORE></span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/about/>About</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/consulting/>Consulting</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/contact/>Contact</a></li></ul></li></ul></div><div id=top-search><a href=# class=search><i class="fa fa-search"></i></a><div class=show-search><form role=search method=get action=https://www.google.com/search id=searchform><input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://www.asquaredozen.com>
<button type=submit value=Search></form></div></div><div class=menu id=menu-mobile></div></div></div><header id=header class=noslider><div class=container><div id=logo><h1><a href=https://www.asquaredozen.com><img src=/img/A-Square-Dozen-Logo-BlogHeader-1.png alt="A Square Dozen"></a></h1></div></div></header><div class=container><div id=content><div id=main class=fullwidth><article class="post type-post status-publish format-standard has-post-thumbnail hentry"><div class=post-header><h1>Configuring 802.1x Authentication for Windows Deployment – Part 4 – Integrating 802.1x Authentication into an In-Place Upgrade Task Sequence</h1><span class=post-date>July 30, 2018</span></div><div class=post-entry><p>This is Part 4 in my <a href=http://www.asquaredozen.com/2018/07/29/configuring-802-1x-authentication-for-windows-deployment/>Configuring 802.1x Authentication for Windows Deployment</a> series. Be sure to check out all of the other parts <a href=http://www.asquaredozen.com/2018/07/29/configuring-802-1x-authentication-for-windows-deployment/>here</a>.</p><h1 id=quick-note-about-cisco-switch-firmware>Quick Note About Cisco Switch Firmware</h1><p>If you&rsquo;ve made it this far, a word of caution. Make sure that your switch firmware is matched to the version required by ISE. I spent several weeks working with our Security and Networking guys to troubleshoot and discovered that our switches weren&rsquo;t at the required version for ISE 2.2. An device plugged in through an IP phone would get blocked by the switch during an In-Place Upgrade and could only reset the port by rebooting the phone. Applying the latest firmware resolved this issue.</p><hr><p>If you are using a ConfigMgr Task Sequence to manage In-Place upgrades or Windows 10 Feature Updates, you will want to take a look at this.</p><p>A Windows In-Place Upgrade or Feature Update perform in much the same way. The setup media is staged on the machine, then the existing OS is moved to a new Windows.old folder. The new OS, updates and drivers are all applied. Then any apps/data/settings that you chose to migrate are applied. According to the Windows 10 Product Group (via Microsoft Premier Support), an In-Place upgrade should migrate 802.1x settings. However, in my experience, this has not been the case, at least during an In-Place Upgrade Task Sequence.</p><h1 id=heres-whats-supposed-to-happen>Here&rsquo;s what&rsquo;s supposed to happen</h1><p>802.1x local profiles as well as 802.1x policies are picked up and moved to a staging location called <strong>C:\ProgramData\Microsoft\dot3vc\MigrationData</strong>. There are corresponding registry keys as well under <strong>HKLM\Software\Microsoft\dot3svc\MigrationData</strong>. If you had a GPO Profile applied, it will be converted to a Local Profile and applied until GPO&rsquo;s can process once the Task Sequence if complete. If you don&rsquo;t have a GPO, then any Local Profile will be applied. If no Local Profile exists, then why did you turn on 802.1x to begin with?? Actually, you will always have a local profile. If you were to delete your profile and restart <strong>dot3svc</strong>, a new default profile will be applied. So, that&rsquo;s what&rsquo;s <strong>SUPPOSED</strong> to happen.</p><h1 id=heres-what-really-happens>Here&rsquo;s what really happens</h1><p>The OS migration completes, and your 802.1x profile has been set back to default. When Windows setup finishes, the computer doesn&rsquo;t reboot, but just calls the Task Sequence environment to resume at the next step. You will see your Task Sequence timeout as it attempts to send a status back to the server. If your next step requires access to the network, it would just fail. You can check your adapter or your 802.1x admin console and see that the computer will have failed to authenticate.</p><h1 id=the-problem>The Problem</h1><p>The 802.1x migration process doesn&rsquo;t complete it&rsquo;s migration until the Wired Authconfig (dot3svc) service is restarted either manually or via reboot. You can reproduce with using standalone upgrade media. When you log in, your authentication profile will be reset to default until you restart dot3svc.</p><h1 id=possible-solutions>Possible Solutions</h1><p>There are several options to consider here.</p><ol><li><strong>Ignore initial authentication failures</strong> when the Task Sequence resumes and restart dot3svc as the first step after Upgrade Operating System. - This option is bad because you run the risk of having ports blocked after repeated failed authentication attempts. Many of our computers are connected to the LAN through their VOIP phones. If a computer fails authentication twice, that device will be blocked from any further traffic until the phone is rebooted. (This could be environmental for us or a bug, but why risk a bunch of unnecessary failures?)</li><li><strong>Edit the upgrade_bulk.XML file</strong> in the Sources directory of your Upgrade media to add the Profile or GPO files to the Include sections. - I have tested and this does work, but it seems less than ideal. the Product Group has a specific process in place to perform this migration in a specific way and I don&rsquo;t like hacking things up (too much) if I don&rsquo;t have to. This was a great workaround, but not the best option.</li><li><strong>Edit the SetupCompleteTemplate.cmd and SetupRollbackTemplate.cmd</strong> files to restart the service DURING the OS upgrade process so the Task Sequence never fails to authenticate. - This is the option that I&rsquo;m going go over here. It seems to be the most robust option given the alternatives.</li></ol><h1 id=setupcompletetemplatecmd-and-setuprollbacktemplatecmd-files>SetupCompleteTemplate.cmd and SetupRollbackTemplate.cmd Files</h1><p>Thanks for the info <a href=https://garytown.com/customize-setupcomplete>Gary Blok</a>!<br>If you check your <strong>C:\Windows\CCM</strong> folder, you will find these 2 files sitting there. They are part of your client install payload and the sources can be found on your SCCM Primary server (Though I wouldn&rsquo;t recommend editing them directly). Make a copy of these files and add them to a new ConfigMgr Package - don&rsquo;t distribute them yet, we need to edit them. Make 2 folders <strong>Original</strong> and <strong>Modified</strong>. Add both files to both folders. Now open the copies from the <strong>Modified</strong> folder. They should look like this:</p><p><code>SetupCompleteTemplate.cmd</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-32>32</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:teal>@ECHO</span> OFF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>REM SCCMClientPath should be <span style=color:#0086b3>set </span>before we get here
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>REM This script is written by ConfigMgr Task Sequence Upgrade Operating System action 
</span></span><span style=display:flex><span>REM SetupComplete.cmd -- Upgrade Complete, calling TSMBootstrap to resume task sequence 
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Entering setupcomplete.cmd &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Setting env var _SMSTSSetupRollback=FALSE &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span><span style=color:#0086b3>set </span>_SMSTSSetupRollback=FALSE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Setting registry to resume task sequence after reboot &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v SetupType /t REG_DWORD /d 2 /f
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v CmdLine /t REG_SZ /d <span style=color:#d14>&#34;%WINDIR%\SMSTSPostUpgrade\setupcomplete.cmd&#34;</span> /f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Running <span style=color:#000;font-weight:700>%</span>SCCMClientPath%\TSMBootstrap.exe to resume task sequence &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>%</span>SCCMClientPath%\TSMBootstrap.exe /env<span style=color:#a61717;background-color:#e3d2d2>:</span>Gina /configpath<span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:#000;font-weight:700>%</span>_SMSTSMDataPath% /bootcount<span style=color:#a61717;background-color:#e3d2d2>:</span>2 /reloadenv
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>IF</span> <span style=color:#000;font-weight:700>%</span>ERRORLEVEL% EQU -2147021886 (
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% ERRORLEVEL = <span style=color:#000;font-weight:700>%</span>ERRORLEVEL%  &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% TSMBootstrap requested reboot &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Rebooting now &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v SetupShutdownRequired /t REG_DWORD /d 1 /f
</span></span><span style=display:flex><span>) <span style=color:#000;font-weight:700>else</span> (
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% ERRORLEVEL = <span style=color:#000;font-weight:700>%</span>ERRORLEVEL%  &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% TSMBootstrap did not request reboot, resetting registry &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v SetupType /t REG_DWORD /d 0 /f
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v CmdLine /t REG_SZ /d <span style=color:#d14>&#34;&#34;</span> /f
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Exiting setupcomplete.cmd &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>set </span>SCCMClientPath=
</span></span></code></pre></td></tr></table></div></div><p><code>SetupRollbackTemplate.cmd</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-32>32</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:teal>@ECHO</span> OFF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>REM SCCMClientPath should be <span style=color:#0086b3>set </span>before we get here
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>REM This script is written by ConfigMgr Task Sequence Upgrade Operating System action 
</span></span><span style=display:flex><span>REM SetupRollback.cmd -- Upgrade Rolled back, calling TSMBootstrap to resume task sequence 
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Entering setuprollback.cmd &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Setting env var _SMSTSSetupRollback=TRUE &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span><span style=color:#0086b3>set </span>_SMSTSSetupRollback=TRUE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Setting registry to resume task sequence after reboot &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v SetupType /t REG_DWORD /d 2 /f
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v CmdLine /t REG_SZ /d <span style=color:#d14>&#34;%WINDIR%\SMSTSPostUpgrade\setuprollback.cmd&#34;</span> /f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Running <span style=color:#000;font-weight:700>%</span>SCCMClientPath%\TSMBootstrap.exe to resume task sequence &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>%</span>SCCMClientPath%\TSMBootstrap.exe /env<span style=color:#a61717;background-color:#e3d2d2>:</span>Gina /configpath<span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:#000;font-weight:700>%</span>_SMSTSMDataPath% /bootcount<span style=color:#a61717;background-color:#e3d2d2>:</span>2 /reloadenv
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>IF</span> <span style=color:#000;font-weight:700>%</span>ERRORLEVEL% EQU -2147021886 (
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% ERRORLEVEL = <span style=color:#000;font-weight:700>%</span>ERRORLEVEL%  &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% TSMBootstrap requested reboot &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Rebooting now &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v SetupShutdownRequired /t REG_DWORD /d 1 /f
</span></span><span style=display:flex><span>) <span style=color:#000;font-weight:700>else</span> (
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% ERRORLEVEL = <span style=color:#000;font-weight:700>%</span>ERRORLEVEL%  &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% TSMBootstrap did not request reboot, resetting registry &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v SetupType /t REG_DWORD /d 0 /f
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v CmdLine /t REG_SZ /d <span style=color:#d14>&#34;&#34;</span> /f
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Exiting setuprollback.cmd &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>set </span>SCCMClientPath=
</span></span></code></pre></td></tr></table></div></div><p>These files are used by the <strong>OSDUpgrade.exe</strong> process during the Task Sequence to manage reboots and resume the Task Sequence as needed during the upgrade process. They run with every reboot AFTER Windows Setup completes, so they are the perfect place for us to add our service restart. If you look at the <strong>Upgrade Operating System</strong> step in the <strong>SMSTS.log</strong>, you will see an entry like this:</p><p><div class=image><figure><a href=2018-07-29_22-22-46.jpg target=_blank><img src=2018-07-29_22-22-46.jpg alt="A Square Dozen Image"></a></figure></div></p><p>These files are appended to your Windows setup command line like this:</p><p><code>"C:\_SMSTaskSequence\Packages\XXXXXXXXXX\SETUP.EXE" /ImageIndex 1 /auto Upgrade /quiet /noreboot /postoobe "C:\WINDOWS\SMSTSPostUpgrade\SetupComplete.cmd" /postrollback "C:\WINDOWS\SMSTSPostUpgrade\SetupRollback.cmd"</code></p><h1 id=modifications-for-8021x>Modifications for 802.1x</h1><p>Here&rsquo;s the block of code that I added to my files. You can choose to do more or less. The only one you REALLY need is the restart-service step.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4>4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5>5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-6>6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-7>7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-8>8</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>//Custom Configuration
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% <span style=color:#d14>&#34;Custom Configuration&#34;</span> &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% <span style=color:#d14>&#34;Restarting Wired Autoconfig Services&#34;</span> &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>powershell.exe -command <span style=color:#d14>&#34;restart-service dot3svc -PassThru -verbose;&#34;</span> &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>ping localhost -n 15
</span></span><span style=display:flex><span>netsh lan show interfaces &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>netsh lan show Profiles &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>//<span style=color:#000;font-weight:700>End</span> Custom Configuration
</span></span></code></pre></td></tr></table></div></div><p>These commands will restart the dot3svc then ping local host for 15 seconds (easy way to add a sleep) then log the output of netsh commands for review later if something fails. I made a point previously of mentioning that I&rsquo;m using a Batch file instead of Powershell for ease of support, yet here I&rsquo;m using PowerShell to restart the service. What I found was that the alternative commands like NET or SC must be called as separate STOP and START commands and I had issues with the script waiting for the service to fully stop before attempting to start. PowerShell&rsquo;s Restart-Service handles all of this nicely. Just trying to use the right tool for the job.</p><p>Here&rsquo;s what your files should look like:</p><p><code>SetupCompleteTemplate.cmd</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-32>32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-33>33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-34>34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-35>35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-36>36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-37>37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-38>38</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-39>39</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-40>40</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-41>41</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:teal>@ECHO</span> OFF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>REM SCCMClientPath should be <span style=color:#0086b3>set </span>before we get here
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>REM This script is written by ConfigMgr Task Sequence Upgrade Operating System action 
</span></span><span style=display:flex><span>REM SetupComplete.cmd -- Upgrade Complete, calling TSMBootstrap to resume task sequence 
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Entering setupcomplete.cmd &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Setting env var _SMSTSSetupRollback=FALSE &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span><span style=color:#0086b3>set </span>_SMSTSSetupRollback=FALSE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Setting registry to resume task sequence after reboot &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v SetupType /t REG_DWORD /d 2 /f
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v CmdLine /t REG_SZ /d <span style=color:#d14>&#34;%WINDIR%\SMSTSPostUpgrade\setupcomplete.cmd&#34;</span> /f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>:: //Custom Configuration
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% <span style=color:#d14>&#34;Custom Configuration&#34;</span> &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% <span style=color:#d14>&#34;Restarting Wired Autoconfig Services&#34;</span> &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>powershell.exe -command <span style=color:#d14>&#34;restart-service dot3svc -PassThru -verbose;&#34;</span> &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>ping localhost -n 15
</span></span><span style=display:flex><span>netsh lan show interfaces &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>netsh lan show Profiles &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>:: // <span style=color:#000;font-weight:700>End</span> Custom Configuration
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Running <span style=color:#000;font-weight:700>%</span>SCCMClientPath%\TSMBootstrap.exe to resume task sequence &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>%</span>SCCMClientPath%\TSMBootstrap.exe /env<span style=color:#a61717;background-color:#e3d2d2>:</span>Gina /configpath<span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:#000;font-weight:700>%</span>_SMSTSMDataPath% /bootcount<span style=color:#a61717;background-color:#e3d2d2>:</span>2 /reloadenv
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>IF</span> <span style=color:#000;font-weight:700>%</span>ERRORLEVEL% EQU -2147021886 (
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% ERRORLEVEL = <span style=color:#000;font-weight:700>%</span>ERRORLEVEL%  &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% TSMBootstrap requested reboot &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Rebooting now &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v SetupShutdownRequired /t REG_DWORD /d 1 /f
</span></span><span style=display:flex><span>) <span style=color:#000;font-weight:700>else</span> (
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% ERRORLEVEL = <span style=color:#000;font-weight:700>%</span>ERRORLEVEL%  &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% TSMBootstrap did not request reboot, resetting registry &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v SetupType /t REG_DWORD /d 0 /f
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v CmdLine /t REG_SZ /d <span style=color:#d14>&#34;&#34;</span> /f
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Exiting setupcomplete.cmd &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>set </span>SCCMClientPath=
</span></span></code></pre></td></tr></table></div></div><p><code>SetupRollbackTemplate.cmd</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-32>32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-33>33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-34>34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-35>35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-36>36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-37>37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-38>38</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-39>39</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-40>40</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-41>41</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:teal>@ECHO</span> OFF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>REM SCCMClientPath should be <span style=color:#0086b3>set </span>before we get here
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>REM This script is written by ConfigMgr Task Sequence Upgrade Operating System action 
</span></span><span style=display:flex><span>REM SetupRollback.cmd -- Upgrade Rolled back, calling TSMBootstrap to resume task sequence 
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Entering setuprollback.cmd &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Setting env var _SMSTSSetupRollback=TRUE &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span><span style=color:#0086b3>set </span>_SMSTSSetupRollback=TRUE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Setting registry to resume task sequence after reboot &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v SetupType /t REG_DWORD /d 2 /f
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v CmdLine /t REG_SZ /d <span style=color:#d14>&#34;%WINDIR%\SMSTSPostUpgrade\setuprollback.cmd&#34;</span> /f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>//Custom Configuration
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% <span style=color:#d14>&#34;Custom Configuration&#34;</span> &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% <span style=color:#d14>&#34;Restarting Wired Autoconfig Services&#34;</span> &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>powershell.exe -command <span style=color:#d14>&#34;restart-service dot3svc -PassThru -verbose;&#34;</span> &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>ping localhost -n 15
</span></span><span style=display:flex><span>netsh lan show interfaces &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>netsh lan show Profiles &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setupcomplete.log
</span></span><span style=display:flex><span>:: // <span style=color:#000;font-weight:700>End</span> Custom Configuration
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Running <span style=color:#000;font-weight:700>%</span>SCCMClientPath%\TSMBootstrap.exe to resume task sequence &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>%</span>SCCMClientPath%\TSMBootstrap.exe /env<span style=color:#a61717;background-color:#e3d2d2>:</span>Gina /configpath<span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:#000;font-weight:700>%</span>_SMSTSMDataPath% /bootcount<span style=color:#a61717;background-color:#e3d2d2>:</span>2 /reloadenv
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>IF</span> <span style=color:#000;font-weight:700>%</span>ERRORLEVEL% EQU -2147021886 (
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% ERRORLEVEL = <span style=color:#000;font-weight:700>%</span>ERRORLEVEL%  &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% TSMBootstrap requested reboot &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Rebooting now &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v SetupShutdownRequired /t REG_DWORD /d 1 /f
</span></span><span style=display:flex><span>) <span style=color:#000;font-weight:700>else</span> (
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% ERRORLEVEL = <span style=color:#000;font-weight:700>%</span>ERRORLEVEL%  &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% TSMBootstrap did not request reboot, resetting registry &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v SetupType /t REG_DWORD /d 0 /f
</span></span><span style=display:flex><span>reg add <span style=color:#d14>&#34;HKEY_LOCAL_MACHINE\SYSTEM\Setup&#34;</span> /v CmdLine /t REG_SZ /d <span style=color:#d14>&#34;&#34;</span> /f
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#0086b3>echo </span><span style=color:#000;font-weight:700>%</span>DATE%-<span style=color:#000;font-weight:700>%</span>TIME% Exiting setuprollback.cmd &gt;&gt; <span style=color:#000;font-weight:700>%</span>WINDIR%\setuprollback.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>set </span>SCCMClientPath=
</span></span></code></pre></td></tr></table></div></div><p>Note: Make sure your command lines are BEFORE this line or the Task Sequence will be re-initialized before the service is restarted and you will still see some timeouts.</p><p><code>%SCCMClientPath%\TSMBootstrap.exe /env:Gina /configpath:%_SMSTSMDataPath% /bootcount:2 /reloadenv</code></p><h1 id=update-your-in-place-upgrade-task-sequence>Update Your In-Place Upgrade Task Sequence</h1><p>You should now have 4 files, 2 Modified and 2 Original. We will add these files to your In-Place Upgrade Task Sequence. The Modified files will be copied down to replace the current files then the Original files will be copied down post-upgrade so we aren&rsquo;t leaving behind non-default files.</p><p>Add Run Command Line steps before and after your Upgrade Task Sequence step using the following command lines:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2>2</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>xcopy.exe <span style=color:#d14>&#34;.\Modified\SetupCompleteTemplate.cmd&#34;</span> <span style=color:#000;font-weight:700>%</span>WINDIR%\CCM\ /C /<span style=color:#0086b3>R </span>/Y
</span></span><span style=display:flex><span>xcopy.exe <span style=color:#d14>&#34;.\Modified\SetupRollbackTemplate.cmd&#34;</span> <span style=color:#000;font-weight:700>%</span>WINDIR%\CCM\ /C /<span style=color:#0086b3>R </span>/Y
</span></span></code></pre></td></tr></table></div></div><p><div class=image><figure><a href=2018-07-29_23-00-24.jpg target=_blank><img src=2018-07-29_23-00-24.jpg alt="A Square Dozen Image"></a></figure></div></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2>2</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>xcopy.exe <span style=color:#d14>&#34;.\Original\SetupCompleteTemplate.cmd&#34;</span> <span style=color:#000;font-weight:700>%</span>WINDIR%\CCM\ /C /<span style=color:#0086b3>R </span>/Y
</span></span><span style=display:flex><span>xcopy.exe <span style=color:#d14>&#34;.\Original\SetupRollbackTemplate.cmd&#34;</span> <span style=color:#000;font-weight:700>%</span>WINDIR%\CCM\ /C /<span style=color:#0086b3>R </span>/Y
</span></span></code></pre></td></tr></table></div></div><p><div class=image><figure><a href=2018-07-29_23-00-45.jpg target=_blank><img src=2018-07-29_23-00-45.jpg alt="A Square Dozen Image"></a></figure></div></p><p>It should look something like this:<br><div class=image><figure><a href=2018-07-29_22-59-51.jpg target=_blank><img src=2018-07-29_22-59-51.jpg alt="A Square Dozen Image"></a></figure></div></p><p>That&rsquo;s it! If you went through all 4 parts with me, you should be able to image machines anywhere that has 802.1x network authentication in place.</p><p>Check out <a href=http://www.asquaredozen.com/2018/09/29/configuring-802-1x-authentication-for-windows-deployment-part-5-dynamic-whitelisting-using-the-cisco-ise-external-restful-service/>Part 5</a> for how to skip all of this and just use a web service to whitelist!!</p></div><comments id=comments><script src=https://utteranc.es/client.js repo=AdamGrossTX/asquaredozen issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script></comments></article></div></div></div><footer id=footer><div class=container><div id=footer-copyright><p class=copyright>&copy; 2022 Adam Gross - https://www.asquaredozen.com - A Square Dozen</a></p></div></div></footer></div></body></html>