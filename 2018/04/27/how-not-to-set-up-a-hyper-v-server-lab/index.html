<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=keyword content="ConfigMgr Microsoft MVP Gross Intune Windows">
<meta name=viewport content="width=device-width">
<meta name=description content="A.Gross Blog | Adam Gross Enterprise Mobility MVP">
<link rel="shortcut icon" href=/img/favicon.ico>
<title>How NOT to Set Up a Hyper-V Server Lab-A Square Dozen | A. Gross Blog</title>
<link rel=canonical href=/2018/04/27/how-not-to-set-up-a-hyper-v-server-lab/>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=https://www.asquaredozen.com/css/custom.css>
<script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://www.asquaredozen.com/js/jquery.slicknav.js></script>
<script src=https://www.asquaredozen.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://www.asquaredozen.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DYVXTRTXN4"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-DYVXTRTXN4',{anonymize_ip:!1})}</script>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://www.asquaredozen.com/img/ASquareDozen-Logo_Horiz_Twitter.png">
<meta name=twitter:title content="How NOT to Set Up a Hyper-V Server Lab">
<meta name=twitter:description content="Sorry for all the words. Skip to the end if you just want the punchline
Have you ever had one of those weeks where you just bang your head against the same wall and eventually get some relief? Sometimes, your head breaks open, but other times, the wall breaks. Well I just had one of those weeks but I&rsquo;m not sure how I feel about where this all ended up.">
<meta property="og:title" content="How NOT to Set Up a Hyper-V Server Lab">
<meta property="og:description" content="Sorry for all the words. Skip to the end if you just want the punchline
Have you ever had one of those weeks where you just bang your head against the same wall and eventually get some relief? Sometimes, your head breaks open, but other times, the wall breaks. Well I just had one of those weeks but I&rsquo;m not sure how I feel about where this all ended up.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.asquaredozen.com/2018/04/27/how-not-to-set-up-a-hyper-v-server-lab/"><meta property="og:image" content="https://www.asquaredozen.com/img/ASquareDozen-Logo_Horiz_Twitter.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-04-28T04:49:44+00:00">
<meta property="article:modified_time" content="2018-04-28T04:49:44+00:00"><meta property="og:site_name" content="A Square Dozen | A. Gross Blog">
</head>
<body class="home blog">
<div id=asd-container>
<div id=top-bar>
<div class=container>
<div id=nav-wrapper>
<ul class=menu id=menu-top-menu>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/>Home</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>Feature Updates</span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/08/22/windows-10-feature-updates-leveraging-setupdiag-for-better-reporting/>Windows 10 Feature Updates – Leveraging SetupDiag for Better Reporting</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/10/05/windows-10-feature-updates-the-challenge-of-servicing-in-the-enterprise/>Windows 10 Feature Updates – The Challenge of Servicing in the Enterprise</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/08/25/windows-10-feature-updates-using-custom-action-scripts/>Windows 10 Feature Updates – Using Custom Action Scripts</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/08/25/windows-10-feature-updates-using-setupconfig-ini-to-manage-feature-updates-in-the-enterprise/>Windows 10 Feature Updates – Using Setupconfig.ini to Manage Feature Updates in the Enterprise</a>
</li>
</ul>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/02/12/the-system-center-configuration-manager-adminservice-guide/>
<span>ConfigMgr AdminService</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>802.1x for OSD</span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-1-building-an-802-1x-computer-authentication-script/>Part 1 – Building an 802.1x Computer Authentication Script</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-2-building-an-802-1x-enabled-winpe-boot-image/>Part 2 – Building an 802.1x Enabled WinPE Boot Image</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-3-integrating-802-1x-authentication-into-a-bare-metal-task-sequence/>Part 3 – Integrating 802.1x Authentication into a Bare Metal Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-4-integrating-802-1x-authentication-into-an-in-place-upgrade-task-sequence/>Part 4 – Integrating 802.1x Authentication into an In-Place Upgrade Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/09/29/configuring-802-1x-authentication-for-windows-deployment-part-5-dynamic-whitelisting-using-the-cisco-ise-external-restful-service/>Part 5 – Dynamic Whitelisting using the Cisco ISE External RESTful Service</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-tips-and-tricks/>Tips and Tricks</a>
</li>
</ul>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>Task Sequence Hacks</span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/11/29/building-a-better-task-sequence/>Building a Better Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/04/30/building-a-smarter-task-sequence/>Building a Smarter Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/12/14/building-an-even-better-task-sequence/>Building An Even Better Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/16/clearing-local-group-policies-during-an-windows-7-to-10-in-place-upgrade-task-sequence/>Clearing Local Group Policies during an Windows 7 to 10 In-Place Upgrade Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/10/03/debugging-sccm-configmgr-task-sequences-on-the-fly/>Debugging SCCM/ConfigMgr Task Sequences on the Fly</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/11/dynamically-updating-unattend-xml-during-an-osd-task-sequence-using-mdt-variables-and-zti-scripts/>Dynamically Updating Unattend.XML during an OSD Task Sequence using MDT Variables and ZTI Scripts.</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/06/14/triggering-configmgr-client-actions-from-a-task-sequence/>Triggering ConfigMgr Client Actions from a Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/08/27/using-sccm-task-sequence-variables-as-scripts/>Using SCCM Task Sequence Variables as Scripts</a>
</li>
</ul>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=https://github.com/AdamGrossTX>
<span>GitHub</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>MORE></span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/about/>About</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/consulting/>Consulting</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/contact/>Contact</a>
</li>
</ul>
</li>
</ul>
</div>
<div id=top-search>
<a href=# class=search><i class="fa fa-search"></i></a>
<div class=show-search>
<form role=search method=get action=https://www.google.com/search id=searchform>
<input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://www.asquaredozen.com>
<button type=submit value=Search>
</form>
</div>
</div>
<div class=menu id=menu-mobile></div>
</div>
</div>
<header id=header class=noslider>
<div class=container>
<div id=logo>
<h1><a href=https://www.asquaredozen.com><img src=/img/A-Square-Dozen-Logo-BlogHeader-1.png alt="A Square Dozen"></a></h1>
</div>
</div>
</header>
<div class=container>
<div id=content>
<div id=main class=fullwidth>
<article class="post type-post status-publish format-standard has-post-thumbnail hentry">
<div class=post-header>
<h1>How NOT to Set Up a Hyper-V Server Lab</h1>
<span class=post-date>April 28, 2018</span>
</div>
<div class=post-entry>
<p><em>Sorry for all the words. Skip to the end if you just want the punchline</em></p>
<p>Have you ever had one of those weeks where you just bang your head against the same wall and eventually get some relief? Sometimes, your head breaks open, but other times, the wall breaks. Well I just had one of those weeks but I&rsquo;m not sure how I feel about where this all ended up.</p>
<p>A couple months ago, I used <a href=https://twitter.com/jarwidmark>Johan Ardwidmark&rsquo;s</a> <a href=https://deploymentresearch.com/Research/Post/580/Hydration-Kit-For-Windows-Server-2016-and-ConfigMgr-Current-Technical-Preview-Branch>Hydration Kit for ConfigMgr</a> and built out the lab in my spare time. My company is trying to move toward Azure and AutoPilot for our Windows client management so I&rsquo;m trying to learn about it in my lab. I had just gotten AutoPilot and ConfigMgr Co-Management working when I realized that I had forgotten about setting up AD FS for client authentication (Azure and the <a href=https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect>Azure AD Connect</a> tool supports several authentication options) so I started down that path. After a few nights of poking around and figuring things out, I realized that I didn&rsquo;t have a DMZ for my federation server to serve the external facing AD FS authentication web service. That&rsquo;s when the trouble started.</p>
<p>I&rsquo;m using Hyper-V for this lab. It&rsquo;s a simple setup with 1 Domain Controller and 1 ConfigMgr server plus Windows client VM&rsquo;s for testing builds. They are all connected to a the same Hyper-V <strong>Internal</strong> Virtual Switch that I configured NAT on using <a href=https://twitter.com/AdaptivaAmi>Amy Casto&rsquo;s</a> <a href=https://deploymentresearch.com/Research/Post/558/Setting-Up-New-Networking-Features-in-Server-2016>cool PowerShell tip</a>. Unfortunately, I don&rsquo;t manage domain controllers, DHCP, DNS, etc in my day job. I&rsquo;m a Desktop guy. I let the Server guys handle all that stuff. That&rsquo;s why I used the Hydration Kit instead of manually building my servers - I don&rsquo;t want to deal with setting up Active directory and all that stuff (I should do it, but I don&rsquo;t want to and you can&rsquo;t make me!!).</p>
<p>So there I am with a perfectly working setup and I decided that I had to break it, because I learn best by starting with a working product then tearing it apart to see how it works. Instead of having a private lab network, I thought it would be easier to change the lab to use the same subnet that my Host server/Router were on. During this process, things went south and I ended up deleting all of the records out of DHCP and DNS. I fought with it for a while and ended up reading that I could set up a Routing and Remote Access (RRAS) server that would bridge my internal and external networks without making my Host machine part of my Domain. Johan even had a <a href=https://deploymentresearch.com/Research/Post/285/Using-a-virtual-router-for-your-lab-and-test-environment>link to a write-up</a> for that too, I had just gone with Ami&rsquo;s simple Virtual Switch NAT instead and never realized he had the process documented.</p>
<p><div class=image>
<figure>
<a href=2018-04-27_22-44-04.png target=_blank>
<img src=2018-04-27_22-44-04.png alt="A Square Dozen Image">
</a>
<figcaption>post configuration</figcaption>
</figure>
</div></p>
<p>Then I rebuilt the original subnet but could never get things to talk after that. They would either talk between the DC and RRAS or DC and CM and sometimes not a all, but never all 3 and DHCP never would work. I even disabled all Windows firewalls and uninstalled Defender and still nothing. I used Wireshark to watch traffic and it just kept searching for the DHCP and RRAS servers. I spent several long nights deleting and rebuilding DHCP, DNS and RRAS, deleting NICS and Switches and all sorts of things in between. I watched EVERY tutorial on and read every obscure blog and forum post about Hyper-V, DHCP, DNS, RRAS and AD communication issues. No matter, how simple everyone made it seem, I was still missing something.</p>
<p>Tonight, I had decided that this was it. If it didn&rsquo;t work soon, I was going to delete it all and start over. Then I remembered something that I had skimmed over. Someone said, &lsquo;Don&rsquo;t check the <strong><em>Enable virtual LAN identification</em></strong> box!&rsquo; in Hyper-V. They didn&rsquo;t provide a reason, but the fact that they mentioned it made me wonder. On a whim, I went through and unchecked it from my NICs and <strong>THEY ALL STARTED TALKING</strong>!!!! Several times in the troubleshooting process, I had checked and unchecked that box, along with all of the other settings I kept toggling, thinking it would help when I was using Wireshark to monitor the traffic. It didn&rsquo;t. Just 1 simple check box.</p>
<p><div class=image>
<figure>
<a href=2018-04-27_22-20-29.png target=_blank>
<img src=2018-04-27_22-20-29.png alt="Don&amp;rsquo;t check this box!">
</a>
<figcaption>Don't check this box!</figcaption>
</figure>
</div></p>
<p>Once it was all working, I started Googling and found <a href=https://support.microsoft.com/help/2739081/hyper-v-virtual-machines-cannot-reach-the-network-when-the-vlan-taggin>this</a> KB for server 2008 that seems to indicate this is/was a known issue (clearly I&rsquo;m not &lsquo;in the know&rsquo;). The weird thing about this is that my virtual switches aren&rsquo;t connected to an internal network adapter - the article specifically calls out Intel. I&rsquo;m using the a Hyper-V Virtual Private Switch on my new setup since the Internal switch adds the Hyper-V Host server to become a Router and I figured that wasn&rsquo;t helping things. So, it may not be the exact issue and I&rsquo;m honestly tired of dealing with it and want to get back to whatever it was I was doing before I broke everything. I&rsquo;m just not going to check the box from now on. If you know the answer, please feel free to share and I&rsquo;ll update this post.</p>
<p><div class=image>
<figure>
<a href=2018-04-27_23-17-59.png target=_blank>
<img src=2018-04-27_23-17-59.png alt="A Square Dozen Image">
</a>
</figure>
</div></p>
<h1 id=tldr>TL;DR;</h1>
<p>Don&rsquo;t check the <strong><em>Enable virtual LAN identification</em></strong> box in Hyper-V if you want your VM&rsquo;s to talk to each other.</p>
</div>
<div class=post-share>
<div class="post-share-box share-comments">
hello
</div>
</div>
<div class=post-author>
</div>
<comments id=comments>
<script src=https://utteranc.es/client.js repo=AdamGrossTX/asquaredozen issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script>
</comments>
</article>
</div>
</div>
</div>
<footer id=footer>
<div class=container>
<div id=footer-copyright>
<p class=copyright>&copy; 2021 Adam Gross - https://www.asquaredozen.com - A Square Dozen</a></p>
</div>
</div>
</footer>
</div>
</body>
</html>