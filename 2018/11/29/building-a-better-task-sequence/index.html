<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=keyword content="ConfigMgr Microsoft MVP Gross Intune Windows"><meta name=viewport content="width=device-width"><meta name=description content="A.Gross Blog | Adam Gross Enterprise Mobility MVP"><link rel="shortcut icon" href=/img/favicon.ico><title>Building a Better Task Sequence-A Square Dozen | A. Gross Blog</title><link rel=canonical href=/2018/11/29/building-a-better-task-sequence/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://www.asquaredozen.com/css/custom.css><script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://www.asquaredozen.com/js/jquery.slicknav.js></script>
<script src=https://www.asquaredozen.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://www.asquaredozen.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DYVXTRTXN4"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-DYVXTRTXN4",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.asquaredozen.com/img/ASquareDozen-Logo_Horiz_Twitter.png"><meta name=twitter:title content="Building a Better Task Sequence"><meta name=twitter:description content="Be sure to check out the sequel to this post Building an Even Better Task Sequence.
I&rsquo;ve had this post in the queue for a while now and have been working on a script to help with some of this, but with the release of System Center Configuration Manager 1810 I don&rsquo;t have to hack something together anymore! One of the best new features which allows us to capture the name of the last action using the new variable _SMSTSLastActionName."><meta property="og:title" content="Building a Better Task Sequence"><meta property="og:description" content="Be sure to check out the sequel to this post Building an Even Better Task Sequence.
I&rsquo;ve had this post in the queue for a while now and have been working on a script to help with some of this, but with the release of System Center Configuration Manager 1810 I don&rsquo;t have to hack something together anymore! One of the best new features which allows us to capture the name of the last action using the new variable _SMSTSLastActionName."><meta property="og:type" content="article"><meta property="og:url" content="https://www.asquaredozen.com/2018/11/29/building-a-better-task-sequence/"><meta property="og:image" content="https://www.asquaredozen.com/img/ASquareDozen-Logo_Horiz_Twitter.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-11-29T06:41:41+00:00"><meta property="article:modified_time" content="2018-11-29T06:41:41+00:00"><meta property="og:site_name" content="A Square Dozen | A. Gross Blog"></head><body class="home blog"><div id=asd-container><div id=top-bar><div class=container><div id=nav-wrapper><ul class=menu id=menu-top-menu><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>Feature Updates</span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/08/22/windows-10-feature-updates-leveraging-setupdiag-for-better-reporting/>Windows 10 Feature Updates – Leveraging SetupDiag for Better Reporting</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/10/05/windows-10-feature-updates-the-challenge-of-servicing-in-the-enterprise/>Windows 10 Feature Updates – The Challenge of Servicing in the Enterprise</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/08/25/windows-10-feature-updates-using-custom-action-scripts/>Windows 10 Feature Updates – Using Custom Action Scripts</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/08/25/windows-10-feature-updates-using-setupconfig-ini-to-manage-feature-updates-in-the-enterprise/>Windows 10 Feature Updates – Using Setupconfig.ini to Manage Feature Updates in the Enterprise</a></li></ul></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/02/12/the-system-center-configuration-manager-adminservice-guide/><span>ConfigMgr AdminService</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>802.1x for OSD</span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-1-building-an-802-1x-computer-authentication-script/>Part 1 – Building an 802.1x Computer Authentication Script</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-2-building-an-802-1x-enabled-winpe-boot-image/>Part 2 – Building an 802.1x Enabled WinPE Boot Image</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-3-integrating-802-1x-authentication-into-a-bare-metal-task-sequence/>Part 3 – Integrating 802.1x Authentication into a Bare Metal Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-4-integrating-802-1x-authentication-into-an-in-place-upgrade-task-sequence/>Part 4 – Integrating 802.1x Authentication into an In-Place Upgrade Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/09/29/configuring-802-1x-authentication-for-windows-deployment-part-5-dynamic-whitelisting-using-the-cisco-ise-external-restful-service/>Part 5 – Dynamic Whitelisting using the Cisco ISE External RESTful Service</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-tips-and-tricks/>Tips and Tricks</a></li></ul></li><li class="active menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>Task Sequence Hacks</span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="active menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/11/29/building-a-better-task-sequence/>Building a Better Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/04/30/building-a-smarter-task-sequence/>Building a Smarter Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/12/14/building-an-even-better-task-sequence/>Building An Even Better Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/16/clearing-local-group-policies-during-an-windows-7-to-10-in-place-upgrade-task-sequence/>Clearing Local Group Policies during an Windows 7 to 10 In-Place Upgrade Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/10/03/debugging-sccm-configmgr-task-sequences-on-the-fly/>Debugging SCCM/ConfigMgr Task Sequences on the Fly</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/11/dynamically-updating-unattend-xml-during-an-osd-task-sequence-using-mdt-variables-and-zti-scripts/>Dynamically Updating Unattend.XML during an OSD Task Sequence using MDT Variables and ZTI Scripts.</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/06/14/triggering-configmgr-client-actions-from-a-task-sequence/>Triggering ConfigMgr Client Actions from a Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/08/27/using-sccm-task-sequence-variables-as-scripts/>Using SCCM Task Sequence Variables as Scripts</a></li></ul></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=https://github.com/AdamGrossTX><span>GitHub</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>MORE></span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/about/>About</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/consulting/>Consulting</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/contact/>Contact</a></li></ul></li></ul></div><div id=top-search><a href=# class=search><i class="fa fa-search"></i></a><div class=show-search><form role=search method=get action=https://www.google.com/search id=searchform><input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://www.asquaredozen.com>
<button type=submit value=Search></form></div></div><div class=menu id=menu-mobile></div></div></div><header id=header class=noslider><div class=container><div id=logo><h1><a href=https://www.asquaredozen.com><img src=/img/A-Square-Dozen-Logo-BlogHeader-1.png alt="A Square Dozen"></a></h1></div></div></header><div class=container><div id=content><div id=main class=fullwidth><article class="post type-post status-publish format-standard has-post-thumbnail hentry"><div class=post-header><h1>Building a Better Task Sequence</h1><span class=post-date>November 29, 2018</span></div><div class=post-entry><p>Be sure to check out the sequel to this post <strong><a href=/2018/12/14/building-an-even-better-task-sequence/>Building an Even Better Task Sequence</a></strong>.</p><p>I&rsquo;ve had this post in the queue for a while now and have been working on a script to help with some of this, but with the release of System Center Configuration Manager 1810 I don&rsquo;t have to hack something together anymore! One of the best new features which allows us to capture the name of the last action using the new variable <strong>_SMSTSLastActionName</strong>. I&rsquo;m so excited about this new variable! Let&rsquo;s get to it.</p><h2 id=failure-is-inevitable>Failure is Inevitable</h2><p>No matter how well you build your ConfigMgr Task Sequences, you will encounter failures. When you are testing in your lab, no big deal, but what about failures at a user&rsquo;s desk during an In-Place Upgrade? Adding structure to your Task Sequences that can properly handle the failures will add an extra layer of protection against incomplete deployments going unnoticed.</p><h2 id=try---catch---finally>Try - Catch - Finally</h2><p>If you&rsquo;ve ever done any programming, you will likely be familiar with concept of Try-Catch-Finally. The general idea is that Try is your block of code. As it executes, if an error occurs, you can allow the code to continue to execute (non-fatal error) or you can Catch the error (fatal-error). In the Catch block, you can execute additional code to process the error. Then, regardless of what else happens, the Finally block will run to process any additional code that you ALWAYS want to run, no matter the outcome of the previous code. If you structure your Task Sequence using similar logic, you can improve the chances of capturing and remediating failures and reduce the number of failed deployments that make it out into production.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-11>11</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#000;font-weight:700>Try</span> {
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>Do</span> Some Thing.
</span></span><span style=display:flex><span>  Stop (Go to <span style=color:#000;font-weight:700>Catch</span>) <span style=color:#000;font-weight:700>if</span> there<span style=color:#a61717;background-color:#e3d2d2>&#39;</span>s an error.
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>If</span> no error, skip <span style=color:#000;font-weight:700>Catch</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>Catch</span> {
</span></span><span style=display:flex><span>  Evaluate the error and take action as needed.
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>Finally</span> {
</span></span><span style=display:flex><span>  No matter what happened above, <span style=color:#000;font-weight:700>do</span> these steps too.
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=basic-framework>Basic Framework</h2><p>Inside your Task Sequence, always create a top level group. I like doing this so it&rsquo;s easier to copy and paste the entire task sequence. Inside this group, create 4 groups at the same level. Main, Failure, Success, Cleanup.</p><p><div class=image><figure><a href=2018-11-28_23-39-14.jpg target=_blank><img src=2018-11-28_23-39-14.jpg alt="A Square Dozen Image"></a></figure></div></p><p>On the Main, Failure and Success groups, check the <strong>Continue on error</strong> box.</p><p><div class=image><figure><a href=2018-11-28_23-41-46.jpg target=_blank><img src=2018-11-28_23-41-46.jpg alt="A Square Dozen Image"></a></figure></div></p><h2 id=main>Main</h2><p>All of your task sequence logic will go into the Main section. If you already have an existing task sequence, you can just add a Run Task Sequence step and reference it! The biggest thing to keep in mind is that you should never enable <strong>Continue on error</strong> for any step that is critical or required for a deployment to be considered a success. In fact, if you have a step that occasionally fails, try to add logic to detect whether you need to run the step, before attempting it, just to eliminate any unnecessary errors from always showing up in the logs. Additionally, failures fail up the the parent group, so you could have steps fail inside a group, but have the group continue using <strong>Continue on error</strong>.
As the last step in Main, add:</p><p><strong>Type:</strong> <code>Set Task Sequence Variable</code><br><strong>Name:</strong> <code>Set AllStepsSucceeded = True</code><br><strong>Task Sequence Variable:</strong> <code>AllStepsSucceeded</code><br><strong>Value:</strong> <code>True</code></p><p>By setting this variable, we will know whether we made it to the end without any fatal errors.</p><h2 id=failure>Failure</h2><p>Next, select the <strong>Failure</strong> group and select <strong>Options</strong> and add the following Condition: <strong>Task Sequence Variable _SMSTSLastActionSucceeded equals False</strong></p><p><div class=image><figure><a href=2018-11-28_23-55-49.jpg target=_blank><img src=2018-11-28_23-55-49.jpg alt="A Square Dozen Image"></a></figure></div></p><p>This will ensure that the Failure group only gets processed if the previous action failed.</p><p>Add a Set Dynamic Variables step and set the following:</p><p><strong>Variable:</strong> <code>FailedStepName</code><br><strong>Value:</strong> <code>%_SMSTSLastActionName%</code></p><p><strong>Variable:</strong> <code>FailedStepReturnCode</code><br><strong>Value:</strong> <code>%_SMSTSLastActionRetCode%</code></p><p><strong>Variable:</strong> <code>AllStepsSucceeded</code><br><strong>Value:</strong> <code>False</code></p><p><strong>Variable:</strong> <code>SMSTSErrorDialogTimeout</code><br><strong>Value:</strong> <code>86400</code></p><p><div class=image><figure><a href=2018-11-29_0-19-16.jpg target=_blank><img src=2018-11-29_0-19-16.jpg alt="A Square Dozen Image"></a></figure></div></p><p>It&rsquo;s important that this is the first step that you run after a failed step or else you will lose the values. Now that you&rsquo;ve captured them, you can process any additional steps that you need to inside the Failure group.</p><h2 id=success>Success</h2><p>Next, select the <strong>Success</strong> group and select <strong>Options</strong> and add the following Condition: <strong>Task Sequence Variable AllStepsSucceeded equals True</strong>. This will ensure that Success will only run if the task sequence made it to the end without failure. You can add any steps inside here that you would only want to run if the Task Sequence was successful.</p><h2 id=cleanup>Cleanup</h2><p>Finally, on the Cleanup group, add steps like Copy Logs or Remove from Provisioning Mode or any other steps that will help make it easier to triage failed deployments. No matter what you add here, be sure that the final step is this one:</p><p>Properties
<strong>Type:</strong> <code>Run Command Line</code><br><strong>Name:</strong> <code>%FailedStepName%</code><br><strong>Command line:</strong> <code>cmd.exe /c exit %FailedStepReturnCode%</code></p><p>Options
<strong>Task Sequence Variable:</strong> <code>AllStepsSucceeded equals False</code></p><p><div class=image><figure><a href=2018-11-29_0-09-35.jpg target=_blank><img src=2018-11-29_0-09-35.jpg alt="A Square Dozen Image"></a></figure></div></p><p><div class=image><figure><a href=2018-11-29_0-13-29.jpg target=_blank><img src=2018-11-29_0-13-29.jpg alt="A Square Dozen Image"></a></figure></div></p><p>This last step is the one made possible with ConfigMgr 1810. Now, when my Task Sequence fails and the error dialog is still on the screen, it will display the name of the last step that ran before the error occurred using the <code>_SMSTSLastActionName</code> build-in variable.</p><p>The result that a user will see (and likely send you a screenshot of) will show the name of the step that caused the failure now, even though you have already processed all of your cleanup steps, like copying logs. At least at my site, this is a HUGE feature that will make triage much simpler.</p><p><div class=image><figure><a href=2018-11-29_0-52-38.jpg target=_blank><img src=2018-11-29_0-52-38.jpg alt="A Square Dozen Image"></a></figure></div></p><h2 id=summary>Summary</h2><p>If you build a better task sequence, you will build a better deployment experience for your users and your first line workers who have to troubleshoot issues. Next steps to consider would be adding things like splash screens or login blocking policies (lots of great community blogs about these concepts). You could even get fancy and hide the progress dialog box and show a custom one, including the error dialog. There are so many great ways to customize your Task Sequences, I am just really excited about the <strong><code>_SMSTSLastActionName</code></strong> variable!</p><h2 id=download>Download!</h2><p>I know it&rsquo;s not much, but you can download the sample Task Sequence <a href=https://github.com/AdamGrossTX/BlogFiles/raw/master/Building%20A%20Better%20Task%20Sequence.zip>here</a>.</p></div><div class=post-share><div class="post-share-box share-comments">hello</div></div><div class=post-author></div><comments id=comments><script src=https://utteranc.es/client.js repo=AdamGrossTX/asquaredozen issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script></comments></article></div></div></div><footer id=footer><div class=container><div id=footer-copyright><p class=copyright>&copy; 2022 Adam Gross - https://www.asquaredozen.com - A Square Dozen</a></p></div></div></footer></div></body></html>