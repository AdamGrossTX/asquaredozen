<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=keyword content="ConfigMgr Microsoft MVP Gross Intune Windows"><meta name=viewport content="width=device-width"><meta name=description content="A.Gross Blog | Adam Gross Enterprise Mobility MVP"><link rel="shortcut icon" href=/img/favicon.ico><title>Repairing Invalid Win32_UserProfile WMI Class on Windows 7 to 10 In-Place Upgraded Devices-A Square Dozen | A. Gross Blog</title><link rel=canonical href=/2020/01/19/repairing-invalid-win32-userprofile-wmi-class-on-windows-7-to-10-in-place-upgraded-devices/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://www.asquaredozen.com/css/custom.css><script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://www.asquaredozen.com/js/jquery.slicknav.js></script>
<script src=https://www.asquaredozen.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://www.asquaredozen.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DYVXTRTXN4"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-DYVXTRTXN4",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.asquaredozen.com/img/ASquareDozen-Logo_Horiz_Twitter.png"><meta name=twitter:title content="Repairing Invalid Win32_UserProfile WMI Class on Windows 7 to 10 In-Place Upgraded Devices"><meta name=twitter:description content="I recently needed to query the Win32_UserProfile class in WMI for some reporting I was working on. This class is a default Hardware Inventory class in ConfigMgr. I noticed that we had a large number of devices were reporting NULL values for several properties in this class when I queried them in SQL so I decided to investigate. From the ConfigMgr console, I used CMPivot (only one of the best tools ever!"><meta property="og:title" content="Repairing Invalid Win32_UserProfile WMI Class on Windows 7 to 10 In-Place Upgraded Devices"><meta property="og:description" content="I recently needed to query the Win32_UserProfile class in WMI for some reporting I was working on. This class is a default Hardware Inventory class in ConfigMgr. I noticed that we had a large number of devices were reporting NULL values for several properties in this class when I queried them in SQL so I decided to investigate. From the ConfigMgr console, I used CMPivot (only one of the best tools ever!"><meta property="og:type" content="article"><meta property="og:url" content="https://www.asquaredozen.com/2020/01/19/repairing-invalid-win32-userprofile-wmi-class-on-windows-7-to-10-in-place-upgraded-devices/"><meta property="og:image" content="https://www.asquaredozen.com/img/ASquareDozen-Logo_Horiz_Twitter.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-01-19T21:35:28+00:00"><meta property="article:modified_time" content="2020-01-19T21:35:28+00:00"><meta property="og:site_name" content="A Square Dozen | A. Gross Blog"></head><body class="home blog"><div id=asd-container><div id=top-bar><div class=container><div id=nav-wrapper><ul class=menu id=menu-top-menu><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>Feature Updates</span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/08/22/windows-10-feature-updates-leveraging-setupdiag-for-better-reporting/>Windows 10 Feature Updates – Leveraging SetupDiag for Better Reporting</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/10/05/windows-10-feature-updates-the-challenge-of-servicing-in-the-enterprise/>Windows 10 Feature Updates – The Challenge of Servicing in the Enterprise</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/08/25/windows-10-feature-updates-using-custom-action-scripts/>Windows 10 Feature Updates – Using Custom Action Scripts</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/08/25/windows-10-feature-updates-using-setupconfig-ini-to-manage-feature-updates-in-the-enterprise/>Windows 10 Feature Updates – Using Setupconfig.ini to Manage Feature Updates in the Enterprise</a></li></ul></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/02/12/the-system-center-configuration-manager-adminservice-guide/><span>ConfigMgr AdminService</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>802.1x for OSD</span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-1-building-an-802-1x-computer-authentication-script/>Part 1 – Building an 802.1x Computer Authentication Script</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-2-building-an-802-1x-enabled-winpe-boot-image/>Part 2 – Building an 802.1x Enabled WinPE Boot Image</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-3-integrating-802-1x-authentication-into-a-bare-metal-task-sequence/>Part 3 – Integrating 802.1x Authentication into a Bare Metal Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-4-integrating-802-1x-authentication-into-an-in-place-upgrade-task-sequence/>Part 4 – Integrating 802.1x Authentication into an In-Place Upgrade Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/09/29/configuring-802-1x-authentication-for-windows-deployment-part-5-dynamic-whitelisting-using-the-cisco-ise-external-restful-service/>Part 5 – Dynamic Whitelisting using the Cisco ISE External RESTful Service</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-tips-and-tricks/>Tips and Tricks</a></li></ul></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>Task Sequence Hacks</span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/11/29/building-a-better-task-sequence/>Building a Better Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2019/04/30/building-a-smarter-task-sequence/>Building a Smarter Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/12/14/building-an-even-better-task-sequence/>Building An Even Better Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/16/clearing-local-group-policies-during-an-windows-7-to-10-in-place-upgrade-task-sequence/>Clearing Local Group Policies during an Windows 7 to 10 In-Place Upgrade Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/10/03/debugging-sccm-configmgr-task-sequences-on-the-fly/>Debugging SCCM/ConfigMgr Task Sequences on the Fly</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/07/11/dynamically-updating-unattend-xml-during-an-osd-task-sequence-using-mdt-variables-and-zti-scripts/>Dynamically Updating Unattend.XML during an OSD Task Sequence using MDT Variables and ZTI Scripts.</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/06/14/triggering-configmgr-client-actions-from-a-task-sequence/>Triggering ConfigMgr Client Actions from a Task Sequence</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/2018/08/27/using-sccm-task-sequence-variables-as-scripts/>Using SCCM Task Sequence Variables as Scripts</a></li></ul></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=https://github.com/AdamGrossTX><span>GitHub</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>MORE></span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/about/>About</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/consulting/>Consulting</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/contact/>Contact</a></li></ul></li></ul></div><div id=top-search><a href=# class=search><i class="fa fa-search"></i></a><div class=show-search><form role=search method=get action=https://www.google.com/search id=searchform><input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://www.asquaredozen.com>
<button type=submit value=Search></form></div></div><div class=menu id=menu-mobile></div></div></div><header id=header class=noslider><div class=container><div id=logo><h1><a href=https://www.asquaredozen.com><img src=/img/A-Square-Dozen-Logo-BlogHeader-1.png alt="A Square Dozen"></a></h1></div></div></header><div class=container><div id=content><div id=main class=fullwidth><article class="post type-post status-publish format-standard has-post-thumbnail hentry"><div class=post-header><h1>Repairing Invalid Win32_UserProfile WMI Class on Windows 7 to 10 In-Place Upgraded Devices</h1><span class=post-date>January 19, 2020</span></div><div class=post-entry><p>I recently needed to query the <a href=https://docs.microsoft.com/previous-versions/windows/desktop/legacy/ee886409(v%3Dvs.85)>Win32_UserProfile</a> class in WMI for some reporting I was working on. This class is a default Hardware Inventory class in ConfigMgr. I noticed that we had a large number of devices were reporting NULL values for several properties in this class when I queried them in SQL so I decided to investigate. From the ConfigMgr console, I used <a href=https://docs.microsoft.com/configmgr/core/servers/manage/cmpivot>CMPivot</a> (only one of the best tools ever!!) to query the class (Listed as USMUserProfile in CMPivot). As CMPivot returned results, I noticed that about half of my devices were returning with a failure message and as I dug into the errors, I made a few discoveries and may have found a bug with the In-Place upgrade process for Windows 7 to Windows 10.</p><p><div class=image><figure><a href=image-2.png target=_blank><img src=image-2.png alt="Win32_UserProfile Class in ConfigMgr Client Hardware Inventory"></a><figcaption>Win32_UserProfile Class in ConfigMgr Client Hardware Inventory</figcaption></figure></div></p><h2 id=cmpivot-results>CMPivot Results</h2><p>If you&rsquo;ve ever worked with SQL or WMI/WQL queries, you&rsquo;ve likely heard the advice that you shouldn&rsquo;t use <code>SELECT * FROM table</code> but should specifically list the columns that you want to query like <code>SELECT ColA, ColB, ColC FROM table</code> to have better query performance and only return the data needed for your specific query. Without going into too much detail on how CMPivot works, the bit that&rsquo;s relevant to this post is that whenever you query a class in CMPivot, it explicitly lists out the columns in the query that it sends down to the client.
In this case, I selected the USMUserProfile entity from CMPivot and clicked Run Query.</p><p><div class=image><figure><a href=image.png target=_blank><img src=image.png alt="A Square Dozen Image"></a></figure></div></p><p>The WMI query that CMPivot attempts to run on the client is:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-19>19</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#0086b3>SELECT </span>
</span></span><span style=display:flex><span>  HealthStatus,
</span></span><span style=display:flex><span>  LastAttemptedProfileDownloadTime,
</span></span><span style=display:flex><span>  LastAttemptedProfileUploadTime,
</span></span><span style=display:flex><span>  LastBackgroundRegistryUploadTime,
</span></span><span style=display:flex><span>  LastDownloadTime,
</span></span><span style=display:flex><span>  LastUploadTime,
</span></span><span style=display:flex><span>  LastUseTime,
</span></span><span style=display:flex><span>  Loaded,
</span></span><span style=display:flex><span>  LocalPath,
</span></span><span style=display:flex><span>  RefCount,
</span></span><span style=display:flex><span>  RoamingConfigured,
</span></span><span style=display:flex><span>  RoamingPath,
</span></span><span style=display:flex><span>  RoamingPreference,
</span></span><span style=display:flex><span>  SID,
</span></span><span style=display:flex><span>  Special,
</span></span><span style=display:flex><span>  Status 
</span></span><span style=display:flex><span>FROM 
</span></span><span style=display:flex><span>	Win32_UserProfile
</span></span></code></pre></td></tr></table></div></div><p>In CMPivot, click on <strong>Query Summary</strong> to view Success, Failed and Offline totals and click through to see details for each category.</p><p><div class=image><figure><a href=image-3.png target=_blank><img src=image-3.png alt="Summary of CMPivot Query Results"></a><figcaption>Summary of CMPivot Query Results</figcaption></figure></div></p><p><div class=image><figure><a href=image-4.png target=_blank><img src=image-4.png alt="A Square Dozen Image"></a><figcaption>Failed Device details in CMPivot</figcaption></figure></div></p><p>As you can see, my Failed Devices details show &lsquo;<strong>Invalid query&mldr;</strong>&rsquo;.</p><h2 id=manually-validating-the-query>Manually Validating the Query</h2><p>I exported the list of failures from CMPivot and was able to get the full query posted above. I connected to a failed machine directly and ran the query in PowerShell:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#0086b3>Get-CIMInstance</span> -Namespace <span style=color:#d14>&#34;root\cimv2&#34;</span> -Query <span style=color:#d14>&#34;SELECT HealthStatus,LastAttemptedProfileDownloadTime,LastAttemptedProfileUploadTime,LastBackgroundRegistryUploadTime,LastDownloadTime,LastUploadTime,LastUseTime,Loaded,LocalPath,RefCount,RoamingConfigured,RoamingPath,RoamingPreference,SID,Special,Status FROM Win32_UserProfile
</span></span></span></code></pre></td></tr></table></div></div><p>And got these results:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4>4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5>5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-6>6</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#0086b3>PS </span>C:\WINDOWS\system32&gt; <span style=color:#0086b3>Get-CIMInstance</span> -Namespace <span style=color:#d14>&#34;root\cimv2&#34;</span> -Query <span style=color:#d14>&#34;SELECT HealthStatus,LastAttemptedProfileDownloadTime,LastAttemptedProfileUploadTime,LastBackgroundRegistryUploadTime,LastDownloadTime,LastUploadTime,LastUseTime,Loaded,LocalPath,RefCount,RoamingConfigured,RoamingPath,RoamingPreference,SID,Special,Status FROM Win32_UserProfile&#34;</span>           <span style=color:#0086b3>Get-CIMInstance</span> <span style=color:#a61717;background-color:#e3d2d2>:</span> Invalid query
</span></span><span style=display:flex><span>At line<span style=color:#a61717;background-color:#e3d2d2>:</span>1 char<span style=color:#a61717;background-color:#e3d2d2>:</span>1
</span></span><span style=display:flex><span>+ <span style=color:#0086b3>Get-CIMInstance</span> -Namespace <span style=color:#d14>&#34;root\cimv2&#34;</span> -Query <span style=color:#d14>&#34;SELECT HealthStatus,L ...
</span></span></span><span style=display:flex><span><span style=color:#d14>+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span></span></span><span style=display:flex><span><span style=color:#d14>    + CategoryInfo          : InvalidArgument: (:) [Get-CimInstance], CimException
</span></span></span><span style=display:flex><span><span style=color:#d14>    + FullyQualifiedErrorId : HRESULT 0x80041017,Microsoft.Management.Infrastructure.CimCmdlets.GetCimInstanceCommand
</span></span></span></code></pre></td></tr></table></div></div><p>Then I ran tried with <code>SELECT *</code>:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#0086b3>Get-CIMInstance</span> -Namespace <span style=color:#d14>&#34;root\cimv2&#34;</span> -Query <span style=color:#d14>&#34;SELECT * FROM Win32_UserProfile
</span></span></span></code></pre></td></tr></table></div></div><p>And got results!!:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-15>15</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#0086b3>PS </span>C:\WINDOWS\system32&gt; <span style=color:#0086b3>Get-CIMInstance</span> -Namespace <span style=color:#d14>&#34;root\cimv2&#34;</span> -Query <span style=color:#d14>&#34;SELECT * FROM Win32_UserProfile&#34;</span>                
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LastDownloadTime  <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>LastUploadTime    <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>LastUseTime       <span style=color:#a61717;background-color:#e3d2d2>:</span> 1/19/2020 1<span style=color:#a61717;background-color:#e3d2d2>:</span>44<span style=color:#a61717;background-color:#e3d2d2>:</span>54 PM
</span></span><span style=display:flex><span>Loaded            <span style=color:#a61717;background-color:#e3d2d2>:</span> True
</span></span><span style=display:flex><span>LocalPath         <span style=color:#a61717;background-color:#e3d2d2>:</span> C:\Users\Gross
</span></span><span style=display:flex><span>RefCount          <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>RoamingConfigured <span style=color:#a61717;background-color:#e3d2d2>:</span> False
</span></span><span style=display:flex><span>RoamingPath       <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>RoamingPreference <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>SID               <span style=color:#a61717;background-color:#e3d2d2>:</span> S-1-5-21-3437610054-3136568823-3853729785-1003
</span></span><span style=display:flex><span>Special           <span style=color:#a61717;background-color:#e3d2d2>:</span> False
</span></span><span style=display:flex><span>Status            <span style=color:#a61717;background-color:#e3d2d2>:</span> 0
</span></span><span style=display:flex><span>PSComputerName    <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span></code></pre></td></tr></table></div></div><p>By looking at the results, I could see that a lot of the properties listed in the CMPivot query aren&rsquo;t listed. Then I checked a device that successfully reported results in CMPivot and the results were much better.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-32>32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-33>33</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#0086b3>PS </span>C:\Windows\system32&gt; <span style=color:#0086b3>Get-CIMInstance</span> -Namespace <span style=color:#d14>&#34;root\cimv2&#34;</span> -Query <span style=color:#d14>&#34;SELECT HealthStatus,LastAttemptedProfileDownloadTime,LastAttemptedProfileUploadTime,LastBackgroundRegistryUploadTime,LastDownloadTime,LastUploadTime,LastUseTime,Loaded,LocalPath,RefCount,RoamingConfigured,RoamingPath,RoamingPreference,SID,Special,Status FROM Win32_UserProfile&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>AppDataRoaming                   <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>Contacts                         <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>Desktop                          <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>Documents                        <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>Downloads                        <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>Favorites                        <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>HealthStatus                     <span style=color:#a61717;background-color:#e3d2d2>:</span> 3
</span></span><span style=display:flex><span>LastAttemptedProfileDownloadTime <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>LastAttemptedProfileUploadTime   <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>LastBackgroundRegistryUploadTime <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>LastDownloadTime                 <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>LastUploadTime                   <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>LastUseTime                      <span style=color:#a61717;background-color:#e3d2d2>:</span> 1/19/2020 1<span style=color:#a61717;background-color:#e3d2d2>:</span>49<span style=color:#a61717;background-color:#e3d2d2>:</span>06 PM
</span></span><span style=display:flex><span>Links                            <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>Loaded                           <span style=color:#a61717;background-color:#e3d2d2>:</span> True
</span></span><span style=display:flex><span>LocalPath                        <span style=color:#a61717;background-color:#e3d2d2>:</span> C:\Users\Adam
</span></span><span style=display:flex><span>Music                            <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>Pictures                         <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>RefCount                         <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>RoamingConfigured                <span style=color:#a61717;background-color:#e3d2d2>:</span> False
</span></span><span style=display:flex><span>RoamingPath                      <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>RoamingPreference                <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>SavedGames                       <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>Searches                         <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>SID                              <span style=color:#a61717;background-color:#e3d2d2>:</span> S-1-5-21-86492988-3276933293-758329271-1001
</span></span><span style=display:flex><span>Special                          <span style=color:#a61717;background-color:#e3d2d2>:</span> False
</span></span><span style=display:flex><span>StartMenu                        <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>Status                           <span style=color:#a61717;background-color:#e3d2d2>:</span> 0
</span></span><span style=display:flex><span>Videos                           <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span><span style=display:flex><span>PSComputerName                   <span style=color:#a61717;background-color:#e3d2d2>:</span>
</span></span></code></pre></td></tr></table></div></div><p>As you can see, there are a lot more properties listed.</p><h2 id=further-investigation>Further Investigation</h2><p>One thing that I knew about our environment was that we had In-Place Upgraded about 50% of our devices from Windows 7 to Windows 10. The number of failure was close to 50%, so on a hunch I began comparing results from known upgraded devices to new builds and discovered that ALL of my upgraded devices had Win32_UserProfile classes with missing properties when compared to Windows 10 new builds!</p><p>I reached out to some folks over on the <a href=http://aka.ms/winadmins>WinAdmins Discord</a> to help get some validation of what I was seeing (thanks guys!) and they were able to duplicate the results. I also spun up some Hyper-V VMs to test and proved that a clean (build from MSDN ISO media) Windows 7 SP1 device, upgraded to Windows 10 (1809/1903/1909 were tested) all ended up with missing properties for Win32_UserProfile.</p><h4 id=steps-to-reproduce>Steps to reproduce</h4><ol><li>In Hyper-V, create a new VM with the Windows 7 SP 1 ISO.</li><li>Log into Windows 7</li><li>In PowerShell run <code>Get-WMIObject Win32_UserProfile</code> and save the results.</li><li>Mount a Windows 10 ISO (I&rsquo;ve tested with 1809/1903/1909) and upgrade or push a feature update from WU/WSUS/ConfigMgr.</li><li>Log into Windows 10.</li><li>In PowerShell run <code>Get-WMIObject Win32_UserProfile</code> and save the results.</li><li>Compare the results from step 3 and 6. They should be the same.</li><li>In Hyper-V, create a new VM with Windows 10 ISO media.</li><li>Log in to Windows 10.</li><li>In PowerShell run <code>Get-WMIObject Win32_UserProfile</code> and save the results.</li><li>Compare results from steps 3, 6 and 10. Step 10 will have many more properties.</li></ol><p>This got me wondering if there were more classes in WMI that were incomplete so I wrote a quick PowerShell script (sorry, I don&rsquo;t have the code - not sure what I did with it) to query the classes and property names from WMI then I just dropped the results into <a href=https://code.visualstudio.com/>VSCode</a> and did a comparison between the results. The Win32_UserProfile class was the only one that had extra properties between a 7-10 upgrade vs a new build.</p><p>I also copied the <code>c:\Windows\System32\wbem</code> folders from the 3 machine states Win7, Win10-post upgrade and Win10 new build and compared them in VSCode and determined that the MOF files for the Upgraded machine matched the New build. This appears to indicate that there may be a process that performs a MOFCOMP on the files post-upgrade that is failing to process this particular class. These are the files that I looked at:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span> <span style=color:#d14>&#34;C:\Windows\System32\wbem\UserProfileWmiProvider.mof&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#d14>&#34;C:\Windows\System32\wbem\UserProfileConfigurationWmiProvider.mof&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#d14>&#34;C:\Windows\System32\wbem\en-us\UserProfileWmiProvider.mfl&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#d14>&#34;C:\Windows\System32\wbem\en-us\UserProfileConfigurationWmiProvider.mfl
</span></span></span></code></pre></td></tr></table></div></div><h2 id=repairing-wmi>Repairing WMI</h2><p>After determining that there wasn&rsquo;t a larger issue at play here, I decided that I just needed to repair the WMI class. If you&rsquo;ve been working with Windows for any length of time, you&rsquo;ve likely run across scripts to repair WMI. Unfortunately, they are often brute force and possibly cause more damage than they fix. Given the fact that I don&rsquo;t even know the impact of this class being incomplete, I just wanted to fix it, but not break more things. This will impact about 3000 production devices and I don&rsquo; think that running <code>WINMGMT /ResetRepository</code> would be the best route. After digging and testing, I finally settled on a script that appears to do the trick. I&rsquo;ve written it so that it can be re-used to repair other WMI classes and can be pushed as a Configuration Baseline in ConfigMgr. It simply checks to see if the class is missing the HealthStatus property and if so, uses MOFCOMP to recompile the MOFs for the class.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-32>32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-33>33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-34>34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-35>35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-36>36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-37>37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-38>38</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-39>39</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-40>40</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-41>41</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-42>42</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-43>43</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-44>44</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-45>45</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-46>46</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-47>47</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-48>48</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-49>49</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-50>50</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-51>51</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-52>52</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-53>53</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-54>54</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-55>55</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#998;font-style:italic>#In a ConfigMgr CI, Use $Remediate = $False for the detection script and $Remediate = $True for the remediation script. This keeps you from needing to maintain 2 scripts.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>param</span>(
</span></span><span style=display:flex><span>    [<span style=color:#000;font-weight:700>Parameter</span>()]
</span></span><span style=display:flex><span>    <span style=color:teal>[string]</span>
</span></span><span style=display:flex><span>    <span style=color:teal>$InputParam</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [<span style=color:#000;font-weight:700>Parameter</span>()]
</span></span><span style=display:flex><span>    <span style=color:teal>[switch]</span>
</span></span><span style=display:flex><span>    <span style=color:teal>$Remediate</span> = <span style=color:teal>$False</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [<span style=color:#000;font-weight:700>Parameter</span>()]
</span></span><span style=display:flex><span>    <span style=color:teal>[string]</span>
</span></span><span style=display:flex><span>    <span style=color:teal>$NameSpace</span> = <span style=color:#d14>&#34;root\cimv2&#34;</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [<span style=color:#000;font-weight:700>Parameter</span>()]
</span></span><span style=display:flex><span>    <span style=color:teal>[string]</span>
</span></span><span style=display:flex><span>    <span style=color:teal>$ClassName</span> = <span style=color:#d14>&#34;Win32_UserProfile&#34;</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [<span style=color:#000;font-weight:700>Parameter</span>()]
</span></span><span style=display:flex><span>    <span style=color:teal>[string]</span>
</span></span><span style=display:flex><span>    <span style=color:teal>$ValidProperty</span> = <span style=color:#d14>&#34;HealthStatus&#34;</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [<span style=color:#000;font-weight:700>Parameter</span>()]
</span></span><span style=display:flex><span>    <span style=color:teal>[string[]]</span> 
</span></span><span style=display:flex><span>    <span style=color:teal>$FileList</span> = @(
</span></span><span style=display:flex><span>        <span style=color:#d14>&#34;C:\Windows\System32\wbem\UserProfileWmiProvider.mof&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#d14>&#34;C:\Windows\System32\wbem\UserProfileConfigurationWmiProvider.mof&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#d14>&#34;C:\Windows\System32\wbem\en-us\UserProfileWmiProvider.mfl&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#d14>&#34;C:\Windows\System32\wbem\en-us\UserProfileConfigurationWmiProvider.mfl&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>Try</span> {
</span></span><span style=display:flex><span>    <span style=color:teal>$Class</span> = <span style=color:#0086b3>Get-CimInstance</span> -Namespace <span style=color:teal>$NameSpace</span> -ClassName <span style=color:teal>$ClassName</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>If</span>(!(<span style=color:teal>$Class</span>[0].PSObject.Properties.Name <span style=color:#000;font-weight:700>-contains</span> <span style=color:teal>$ValidProperty</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>If</span>(<span style=color:teal>$Remediate</span>.IsPresent) {
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>ForEach</span>(<span style=color:teal>$File</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>$FileList</span>) {
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>If</span>(<span style=color:#0086b3>Get-Item</span> -Path <span style=color:teal>$File</span> -ErrorAction Stop) {
</span></span><span style=display:flex><span>                    mofcomp.exe <span style=color:teal>$File</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>Else</span> {
</span></span><span style=display:flex><span>                    <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;File </span>$(<span style=color:teal>$File</span>)<span style=color:#d14> not found.&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>Return</span> 1
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>Else</span> {
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>Return</span> 0
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>Catch</span> {
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>Return</span> 0
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Simply add this to a Configuration Item and deploy in a Configuration Baseline in ConfigMgr and you should be able to repair any broken Win32_UserProfile classes. Obviously, test first. I&rsquo;d start with the CMPivot steps listed above to help identify broken devices.</p><hr><p><strong>Note:</strong> I also verified that performing a Feature Update from 1809 to 1903/1909 doesn&rsquo;t fix the class. Also, creating a new user profile doesn&rsquo;t seem to help either.</p><hr><h2 id=summary>Summary</h2><p>As you can see, this simple query turned into quite the rabbit hole. I don&rsquo;t know if this is an actual bug or even anything to worry about at this stage, I just know that it seems abnormal. I&rsquo;ve forward this information to the Windows Setup team and have asked them to investigate whether this is a bug or by design. As of this post, they have responded indicating they will work to repro and provide feedback once they know more.</p><p>Ultimately, the fact that the MOF shows the correct properties for the class and repairing WMI fixes it, sure seems like there&rsquo;s a bug.</p></div><comments id=comments><script src=https://utteranc.es/client.js repo=AdamGrossTX/asquaredozen issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script></comments></article></div></div></div><footer id=footer><div class=container><div id=footer-copyright><p class=copyright>&copy; 2022 Adam Gross - https://www.asquaredozen.com - A Square Dozen</a></p></div></div></footer></div></body></html>