<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=keyword content="ConfigMgr Microsoft MVP Gross Intune Windows">
<meta name=viewport content="width=device-width">
<meta name=description content="A.Gross Blog | Adam Gross Enterprise Mobility MVP">
<link rel="shortcut icon" href=/img/favicon.ico>
<title>Troubleshooting ConfigMgr Enhanced HTTP and Azure Directory Group Sync-A Square Dozen | A. Gross Blog</title>
<link rel=canonical href=/2020/08/07/troubleshooting-configmgr-enhanced-http-and-azure-directory-group-sync/>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=https://www.asquaredozen.com/css/custom.css>
<script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://www.asquaredozen.com/js/jquery.slicknav.js></script>
<script src=https://www.asquaredozen.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://www.asquaredozen.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DYVXTRTXN4"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-DYVXTRTXN4',{anonymize_ip:!1})}</script>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://www.asquaredozen.com/105">
<meta name=twitter:title content="Troubleshooting ConfigMgr Enhanced HTTP and Azure Directory Group Sync">
<meta name=twitter:description content="Today I got to help my buddy Adam Juelich with getting ConfigMgr Azure Directory Group Sync working. It&rsquo;s an awesome new feature that allows you to sync ConfigMgr collection memberships to your Azure tenant. Adam had followed all of the steps and ensured that prerequisites were all configured properly but sync would never work.
Over a Teams meeting we double checked everything and walked through Ronny Dejong&rsquo;s (He covers pretty much all of troubleshooting steps needed for this!">
</head>
<body class="home blog">
<div id=asd-container>
<div id=top-bar>
<div class=container>
<div id=nav-wrapper>
<ul class=menu id=menu-top-menu>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/>Home</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>Feature Updates</span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/08/22/windows-10-feature-updates-leveraging-setupdiag-for-better-reporting/>Windows 10 Feature Updates – Leveraging SetupDiag for Better Reporting</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/10/05/windows-10-feature-updates-the-challenge-of-servicing-in-the-enterprise/>Windows 10 Feature Updates – The Challenge of Servicing in the Enterprise</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/08/25/windows-10-feature-updates-using-custom-action-scripts/>Windows 10 Feature Updates – Using Custom Action Scripts</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/08/25/windows-10-feature-updates-using-setupconfig-ini-to-manage-feature-updates-in-the-enterprise/>Windows 10 Feature Updates – Using Setupconfig.ini to Manage Feature Updates in the Enterprise</a>
</li>
</ul>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/02/12/the-system-center-configuration-manager-adminservice-guide/>
<span>ConfigMgr AdminService</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>802.1x for OSD</span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-1-building-an-802-1x-computer-authentication-script/>Part 1 – Building an 802.1x Computer Authentication Script</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-2-building-an-802-1x-enabled-winpe-boot-image/>Part 2 – Building an 802.1x Enabled WinPE Boot Image</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-3-integrating-802-1x-authentication-into-a-bare-metal-task-sequence/>Part 3 – Integrating 802.1x Authentication into a Bare Metal Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-part-4-integrating-802-1x-authentication-into-an-in-place-upgrade-task-sequence/>Part 4 – Integrating 802.1x Authentication into an In-Place Upgrade Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/09/29/configuring-802-1x-authentication-for-windows-deployment-part-5-dynamic-whitelisting-using-the-cisco-ise-external-restful-service/>Part 5 – Dynamic Whitelisting using the Cisco ISE External RESTful Service</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/29/configuring-802-1x-authentication-for-windows-deployment-tips-and-tricks/>Tips and Tricks</a>
</li>
</ul>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>Task Sequence Hacks</span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/11/29/building-a-better-task-sequence/>Building a Better Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2019/04/30/building-a-smarter-task-sequence/>Building a Smarter Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/12/14/building-an-even-better-task-sequence/>Building An Even Better Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/16/clearing-local-group-policies-during-an-windows-7-to-10-in-place-upgrade-task-sequence/>Clearing Local Group Policies during an Windows 7 to 10 In-Place Upgrade Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/10/03/debugging-sccm-configmgr-task-sequences-on-the-fly/>Debugging SCCM/ConfigMgr Task Sequences on the Fly</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/07/11/dynamically-updating-unattend-xml-during-an-osd-task-sequence-using-mdt-variables-and-zti-scripts/>Dynamically Updating Unattend.XML during an OSD Task Sequence using MDT Variables and ZTI Scripts.</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/06/14/triggering-configmgr-client-actions-from-a-task-sequence/>Triggering ConfigMgr Client Actions from a Task Sequence</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/2018/08/27/using-sccm-task-sequence-variables-as-scripts/>Using SCCM Task Sequence Variables as Scripts</a>
</li>
</ul>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=https://github.com/AdamGrossTX>
<span>GitHub</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>MORE></span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/about/>About</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/consulting/>Consulting</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/contact/>Contact</a>
</li>
</ul>
</li>
</ul>
</div>
<div id=top-search>
<a href=# class=search><i class="fa fa-search"></i></a>
<div class=show-search>
<form role=search method=get action=https://www.google.com/search id=searchform>
<input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://www.asquaredozen.com>
<button type=submit value=Search>
</form>
</div>
</div>
<div class=menu id=menu-mobile></div>
</div>
</div>
<header id=header class=noslider>
<div class=container>
<div id=logo>
<h1><a href=https://www.asquaredozen.com><img src=/img/A-Square-Dozen-Logo-BlogHeader-1.png alt="A Square Dozen"></a></h1>
</div>
</div>
</header>
<div class=container>
<div id=content>
<div id=main class=fullwidth>
<article class="post type-post status-publish format-standard has-post-thumbnail hentry">
<div class=post-header>
<h1>Troubleshooting ConfigMgr Enhanced HTTP and Azure Directory Group Sync</h1>
<span class=post-date>August 7, 2020</span>
</div>
<div class=post-entry>
<p>Today I got to help my buddy <a href=https://twitter.com/acjuelich>Adam Juelich</a> with getting ConfigMgr <strong><a href=https://docs.microsoft.com/mem/configmgr/core/clients/manage/collections/create-collections#bkmk_aadcollsync>Azure Directory Group Sync</a></strong> working. It&rsquo;s an awesome new feature that allows you to sync ConfigMgr collection memberships to your Azure tenant. Adam had followed all of the steps and ensured that prerequisites were all configured properly but sync would never work.</p>
<p>Over a Teams meeting we double checked everything and walked through <a href=https://ronnydejong.com/2020/02/27/troubleshooting-device-collection-membership-azure-ad-group-sync/>Ronny Dejong&rsquo;s</a> (He covers pretty much all of troubleshooting steps needed for this!), <a href=https://msendpointmgr.com/2019/07/27/synchronize-device-collection-memberships-to-an-azure-ad-group-with-configmgr/>Nickolaj Andersen&rsquo;s</a>, and <a href=https://triplesixseven.com/syncing-device-collections-to-azure-ad/>Jake Stoker&rsquo;s</a> blogs on configuring and troubleshooting the sync, which helped put us on the right track to the issue.</p>
<h2 id=finding-the-issue>Finding the Issue</h2>
<p>HTTPS or <a href=https://docs.microsoft.com/mem/configmgr/core/plan-design/hierarchy/enhanced-http>Enhanced HTTP</a> is required for Azure Directory Group Sync - Adam confirmed that he had EHTTP enabled. According to Ronny&rsquo;s blog, EHTTP is responsible for updating the <strong>AADTenantID</strong> value in the <strong>ClientDataKeys</strong> table in the ConfigMgr SQL database. We were confused because in the ConfigMgr console, you can turn on the <strong>Azure Active Directory Tenant ID</strong> column in any Device view and it was populated for all of the devices in the collection to be synced.</p>
<p><div class=image>
<figure>
<a href=image-26.png target=_blank>
<img src=image-26.png alt="A Square Dozen Image">
</a>
</figure>
</div></p>
<p>However when we queried the <strong>ClientDataKeys</strong> table (Query from Nickolaj&rsquo;s blog) we found that the <strong>AADTenantID</strong> column was <strong>NULL</strong> while the <strong>AADTenantID</strong> column in <strong>System_DISC</strong> (Used by the console views) was populated.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a></span><span style=color:#000;font-weight:700>SELECT</span><span style=color:#bbb> 
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a></span><span style=color:#bbb>	</span>System_DISC.Name0,<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a></span><span style=color:#bbb>	</span>ClientKeyData.SMSID,<span style=color:#bbb> 
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a></span><span style=color:#bbb>	</span>System_DISC.SMS_Unique_Identifier0,<span style=color:#bbb> 
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a></span><span style=color:#bbb>	</span>[ClientKeyData<span style=color:#bbb> </span>AADTenantID]<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>ClientKeyData.AADTenantID,<span style=color:#bbb> 
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a></span><span style=color:#bbb>	</span>[System_DISC<span style=color:#bbb> </span>AADTenantID]<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>System_DISC.AADTenantID<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a></span><span style=color:#bbb></span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb> 
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a></span><span style=color:#bbb>	</span>ClientKeyData<span style=color:#bbb> </span><span style=color:#000;font-weight:700>JOIN</span><span style=color:#bbb> 
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a></span><span style=color:#bbb>	</span>System_DISC<span style=color:#bbb> </span><span style=color:#000;font-weight:700>ON</span><span style=color:#bbb> </span>ClientKeyData.SMSID<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>System_DISC.SMS_Unique_Identifier0<span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a></span><span style=color:#bbb></span><span style=color:#000;font-weight:700>ORDER</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>BY</span><span style=color:#bbb>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a></span><span style=color:#bbb>	</span>ClientKeyData.AADTenantID<span style=color:#bbb> </span><span style=color:#000;font-weight:700>DESC</span><span style=color:#bbb>
</span></code></pre></div><p><div class=image>
<figure>
<a href=2020-08-07_11-25-05.jpg target=_blank>
<img src=2020-08-07_11-25-05.jpg alt="A Square Dozen Image">
</a>
</figure>
</div></p>
<p>Thanks to Ronny for a great description of the difference between the <strong>AADTenantID</strong> values between <strong>System_Disc</strong> and <strong>ClientDataKeys</strong>:</p>
<p><div class=image>
<figure>
<a href=image-24.png target=_blank>
<img src=image-24.png alt="A Square Dozen Image">
</a>
<figcaption>https://ronnydejong.com/2020/02/27/troubleshooting-device-collection-membership-azure-ad-group-sync/</figcaption>
</figure>
</div></p>
<p>Ronny&rsquo;s blog section titled <strong>Validate SSL Communication</strong> would have helped with this next part if I had scrolled down a bit more, but instead we went about it the hard way and got to the same result - Enhanced HTTP wasn&rsquo;t configured even though everything looked correct from the console.</p>
<h2 id=rolling-back-enhanced-http>Rolling back Enhanced HTTP</h2>
<p>When we took a look IIS, we found that HTTPS was enabled but the binding was what Adam described as &lsquo;An Ancient PKI Certificate&rsquo;. I thought this was the fix, just swap the cert to the SMS Role SSL Certificate and we&rsquo;d be good. However, that certificate wasn&rsquo;t in the list. We checked the local certificate store and it wasn&rsquo;t there either. This was a good clue. I verified in my lab that the cert should have been issued. We checked the docs and didn&rsquo;t see anything listed about the new cert until we checked the docs for the <a href=https://docs.microsoft.com/mem/configmgr/core/clients/manage/cmg/certificates-for-cloud-management-gateway#enhanced-http-certificate-for-management-points>Cloud Management Gateway</a> where there&rsquo;s this note, confirming our suspicion:</p>
<blockquote>
<p>When you enable Enhanced HTTP, the site server generates a self-signed certificate named <strong>SMS Role SSL Certificate</strong>, issued by the root SMS Issuing certificate. The management point adds this certificate to the IIS Default Web site bound to port 443.
<a href=https://docs.microsoft.com/mem/configmgr/core/clients/manage/cmg/certificates-for-cloud-management-gateway#enhanced-http-certificate-for-management-points>https://docs.microsoft.com/mem/configmgr/core/clients/manage/cmg/certificates-for-cloud-management-gateway#enhanced-http-certificate-for-management-points</a></p>
</blockquote>
<p>Our fix was to disable EHTTP (just uncheck the box shown in the next section and wait for the change to process (watch sitecomp.log and mpcontrol.log). We also removed the HTTPS binding from IIS. Then we re-enabled EHTTP following the steps below.</p>
<h2 id=enable-and-verify-enhanced-http-configuration-in-iis>Enable and Verify Enhanced HTTP Configuration in IIS</h2>
<p>Follow the steps from the Docs to <a href=https://docs.microsoft.com/mem/configmgr/core/plan-design/hierarchy/enhanced-http>enable Enhanced HTTP</a>.</p>
<p><div class=image>
<figure>
<a href=image-25.png target=_blank>
<img src=image-25.png alt="Enable Enhanced HTTP">
</a>
<figcaption>Enable Enhanced HTTP</figcaption>
</figure>
</div></p>
<p>Check <code>sitecomp.log</code> to see the change get processed.</p>
<p><div class=image>
<figure>
<a href=2020-08-07_11-38-31.png target=_blank>
<img src=2020-08-07_11-38-31.png alt="Detected change in SSLState for client settings.">
</a>
<figcaption>Detected change in SSLState for client settings.</figcaption>
</figure>
</div></p>
<p>This will trigger a change that you can watch in mpcontrol.log (partial log shown here. There will be quite a few log entries here.)</p>
<p><div class=image>
<figure>
<a href=2020-08-07_11-40-22.png target=_blank>
<img src=2020-08-07_11-40-22.png alt="Detected token auth flag is changed. Currently enabled.">
</a>
<figcaption>Detected token auth flag is changed. Currently enabled.</figcaption>
</figure>
</div></p>
<p>A new cert will be generated on the MP. The Friendly Name will be SMS Role SSL Certificate issued by SMS Issuing.</p>
<p><div class=image>
<figure>
<a href=2020-08-07_11-40-48.png target=_blank>
<img src=2020-08-07_11-40-48.png alt="Newly issued Cert Issued By SMS Signing">
</a>
<figcaption>Newly issued Cert Issued By SMS Signing</figcaption>
</figure>
</div></p>
<p>In IIS on the Default Web Site, HTTPS will be added to the site bindings and the SMS Role SSL Certificate will be attached.</p>
<p><div class=image>
<figure>
<a href=2020-08-07_11-41-50.png target=_blank>
<img src=2020-08-07_11-41-50.png alt="HTTPS enabled and new Cert attached">
</a>
<figcaption>HTTPS enabled and new Cert attached</figcaption>
</figure>
</div></p>
<h2 id=test-collection-sync>Test Collection Sync</h2>
<p>Once you&rsquo;ve verified that EHTTPS has been enabled successfully, you can clients will begin updating the ClientDataKeys table. Re-run the query above. Once you see the AADTenantID begin populating, any devices with a value in that column will be eligible to sync if they are in a collection you&rsquo;ve configured for sync. Once you&rsquo;ve verified the data, follow the steps in any of the blogs linked to set up collection sync. <a href=https://triplesixseven.com/syncing-device-collections-to-azure-ad/>Jake has the simplest writeup on the steps</a>. CollectionAADGroupSyncWorker.log and SMS_AZUREAD_DISCOVERY_AGENT.log are good logs to watch when working with Collection Sync. - <a href=https://docs.microsoft.com/mem/configmgr/core/plan-design/hierarchy/log-files>See notes here on log file changes after 1910</a>.</p>
<h2 id=root-cause>Root Cause</h2>
<p><strong>IIS had an HTTPS/443 binding configured with Certificate attached to it</strong> <strong>before enabling EHTTP</strong>.
In my lab testing, if I had already enabled the HTTPS/443 binding (which requires you to select a certificate), when I enabled Enhanced HTTP, the process didn&rsquo;t remove/replace the IIS configuration that was already in place. It also didn&rsquo;t generate the <strong>SMS Role SSL Certificate</strong> as expected.</p>
<p>If you disable EHTTP, the configuration and certificates aren&rsquo;t removed either. I suspect this is by design to prevent the enablement process from overwriting pre-existing configuration.</p>
<h2 id=summary>Summary</h2>
<p>There are lots of moving parts here and the key takeaway should be <strong>Trust but Verify</strong>. As robust as the systems/processes may be within ConfigMgr, sometimes you just need to dig into the logs to verify that things are working as intended - especially if you&rsquo;ve enabled a Preview feature, things change. In this case, we walked through each component, verifying configurations, until we found the misconfiguration.</p>
<p>Special thanks to <a href=https://twitter.com/ronnydejong>Ronny de Jong</a>, <a href=https://twitter.com/NickolajA>Nickolaj Andersen</a> and <a href=https://twitter.com/TripleSixSeven>Jake Stoker</a> for their great posts that helps save a bunch of time and thanks <a href=https://twitter.com/acjuelich>Adam Juelich</a> for letting me lend a hand, though next time it&rsquo;ll have to include some smoked meats.</p>
</div>
<comments id=comments>
<script src=https://utteranc.es/client.js repo=AdamGrossTX/asquaredozen issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script>
</comments>
</article>
</div>
</div>
</div>
<footer id=footer>
<div class=container>
<div id=footer-copyright>
<p class=copyright>&copy; 2021 Adam Gross - https://www.asquaredozen.com - A Square Dozen</a></p>
</div>
</div>
</footer>
</div>
</body>
</html>